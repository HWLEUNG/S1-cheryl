<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆèªå¤§å¯Œç¿ï¼šçµ‚æ¥µå°æ±º</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f1f5f9;
            user-select: none;
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* éœ‡å‹•å‹•ç•« (ç ´ç”¢ç”¨) */
        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- å…§åµŒåœ–ç¤ºçµ„ä»¶ (SVG) ---
        const Icon = ({ path, size = 24, className = "", fill = "none" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            BookOpen: (props) => <Icon {...props} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />,
            Volume2: (props) => <Icon {...props} path={<><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></>} />,
            ArrowRight: (props) => <Icon {...props} path={<><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></>} />,
            Dices: (props) => <Icon {...props} path={<><rect width="12" height="12" x="2" y="10" rx="2" ry="2"/><path d="m17.92 14 3.5-3.5a2.24 2.24 0 0 0 0-3l-5-4.92a2.24 2.24 0 0 0-3 0L10 6"/><path d="M6 18h.01"/><path d="M10 14h.01"/><path d="M15 6h.01"/><path d="M18 9h.01"/></>} />,
            Trophy: (props) => <Icon {...props} path={<><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></>} />,
            User: (props) => <Icon {...props} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />,
            Star: (props) => <Icon {...props} fill={props.fill || "none"} path={<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>} />,
            Crown: (props) => <Icon {...props} path={<><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></>} />,
            Swords: (props) => <Icon {...props} path={<><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" y1="19" x2="19" y2="13"/><line x1="16" y1="16" x2="20" y2="20"/><line x1="19" y1="21" x2="21" y2="19"/><polyline points="14.5 6.5 18 3 21 3 21 6 17.5 9.5"/><line x1="5" y1="14" x2="9" y2="18"/><line x1="7" y1="17" x2="4" y2="20"/><line x1="3" y1="19" x2="5" y2="21"/></>} />,
            ShieldAlert: (props) => <Icon {...props} path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></>} />,
            ShieldCheck: (props) => <Icon {...props} path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></>} />,
            Home: (props) => <Icon {...props} fill={props.fill || "none"} path={<><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>} />,
            ArrowUpCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4"/><path d="M12 16V8"/></>} />,
            Music: (props) => <Icon {...props} path={<><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></>} />,
            VolumeX: (props) => <Icon {...props} path={<><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></>} />,
            Link: (props) => <Icon {...props} path={<><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></>} />,
            Skull: (props) => <Icon {...props} path={<><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="m12.5 17-.5-1-.5 1h1z"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/></>} />
        };

        const FULL_DATA = [
            { id: 10, word: "ä¸€è‘‰çŸ¥ç§‹", meaning: "å½¢å®¹å¾å¾®å°çš„äº‹ç‰©ä¾¿æ¨æ–·å‡ºçµæœã€‚", example: "çœ‹åˆ°åœ°ä¸Šçš„è½è‘‰ï¼Œä¾¿çŸ¥é“ç§‹å¤©ä¾†äº†ï¼Œé€™å°±æ˜¯ä¸€è‘‰çŸ¥ç§‹çš„é“ç†ã€‚" },
            { id: 11, word: "ä¸€è½åƒä¸ˆ", meaning: "åœ°ä½åè²æˆ–äº‹ç‰©å¢ƒæ³æ€¥é€Ÿä¸‹æ»‘ã€‚", example: "è‡ªå¾é‚£æ¬¡é†œèæ›å…‰å¾Œï¼Œä»–åœ¨æ¥­ç•Œçš„è²æœ›ä¸€è½åƒä¸ˆã€‚" },
            { id: 12, word: "å…¥æœ¨ä¸‰åˆ†", meaning: "æ¯”å–»è­°è«–è¦‹è§£éå¸¸æ·±åˆ»ã€ç²¾é—¢ã€‚", example: "é€™ä½è©•è«–å®¶çš„åˆ†æå…¥æœ¨ä¸‰åˆ†ï¼Œç›´æŒ‡å•é¡Œæ ¸å¿ƒã€‚" },
            { id: 13, word: "ä¹æ­»ä¸€ç”Ÿ", meaning: "å½¢å®¹è™•å¢ƒéå¸¸å±éšªï¼Œæ­»è£é€ƒç”Ÿã€‚", example: "åœ¨é‚£å ´å¤§åœ°éœ‡ä¸­ï¼Œä»–ç¶“æ­·äº†ä¹æ­»ä¸€ç”Ÿçš„éšªå¢ƒæ‰è¢«æ•‘å‡ºã€‚" },
            { id: 14, word: "å…«é¢å¨é¢¨", meaning: "å½¢å®¹äººæˆ–äº‹æ°£å‹¢é›„å£¯ï¼Œå¨é¢¨å‡œå‡œã€‚", example: "å°‡è»èº«ç©¿æˆ°ç”²ï¼Œé¨è‘—æˆ°é¦¬ï¼Œé¡¯å¾—å…«é¢å¨é¢¨ã€‚" },
            { id: 15, word: "äººå‚‘åœ°éˆ", meaning: "å½¢å®¹ç§€éº—çš„åœ°æ–¹ï¼Œå­•è‚²å‡ºå‚‘å‡ºäººæ‰ã€‚", example: "è˜‡å·è‡ªå¤äººå‚‘åœ°éˆï¼Œå‡ºäº†è¨±å¤šç‹€å…ƒå’Œæ‰å­ã€‚" },
            { id: 16, word: "åŠ›ä¸å¾å¿ƒ", meaning: "æŒ‡å…§å¿ƒæƒ³åšäº‹ï¼Œä½†èƒ½åŠ›ä¸è¶³ã€‚", example: "å¹´ç´€å¤§äº†ï¼Œæƒ³å»çˆ¬å±±ä¹Ÿå¸¸å¸¸æ„Ÿåˆ°åŠ›ä¸å¾å¿ƒã€‚" },
            { id: 17, word: "ä¸‰æ€è€Œè¡Œ", meaning: "å–»åšäº‹æƒ…å‰è¦å¤šæ¬¡æ·±å…¥è€ƒæ…®æ‰å¯¦è¡Œã€‚", example: "åšé‡å¤§æ±ºå®šå‰ï¼Œä¸€å®šè¦ä¸‰æ€è€Œè¡Œï¼Œä»¥å…å°‡ä¾†å¾Œæ‚”ã€‚" },
            { id: 18, word: "äº¡ç¾Šè£œç‰¢", meaning: "å–»çŠ¯éŒ¯å¾Œï¼Œç«‹å³æƒ³è¾¦æ³•è£œæ•‘ï¼Œä»¥é˜²é‡è¹ˆè¦†è½ã€‚", example: "é›–ç„¶é€™æ¬¡è€ƒè©¦å¤±æ•—äº†ï¼Œä½†åªè¦äº¡ç¾Šè£œç‰¢ï¼ŒåŠªåŠ›æº«ç¿’ï¼Œä¸‹æ¬¡ä¸€å®šèƒ½é€²æ­¥ã€‚" },
            { id: 19, word: "å¤§ç¾©æ»…è¦ª", meaning: "ç¶­è­·æ­£ç¾©ï¼Œä¸å¾‡ç§ï¼Œä¸è¢’è­·å­å¥³è¦ªæ—ã€‚", example: "å³ä½¿æ˜¯è¦ªç”Ÿå…’å­çŠ¯æ³•ï¼Œä»–ä¹Ÿé¸æ“‡å¤§ç¾©æ»…è¦ªï¼Œå°‡å…¶é€å®˜ç©¶è¾¦ã€‚" },
            { id: 20, word: "å¤§ç™¼é›·éœ†", meaning: "å½¢å®¹éå¸¸æ†¤æ€’ï¼Œå¤§ç™¼è„¾æ°£ã€‚", example: "å› ç‚ºå¼Ÿå¼Ÿæ‰“ç ´äº†çè²´çš„èŠ±ç“¶ï¼Œçˆ¸çˆ¸å¤§ç™¼é›·éœ†ã€‚" },
            { id: 21, word: "ä¸Šè¡Œä¸‹æ•ˆ", meaning: "å½¢å®¹ä¸Šç´šæ€æ¨£åšï¼Œä¸‹ç´šè·Ÿè‘—ä»¿æ•ˆã€‚", example: "ä¸»ç®¡å¸¶é ­å‹¤å¥®å·¥ä½œï¼Œå“¡å·¥è‡ªç„¶ä¸Šè¡Œä¸‹æ•ˆï¼Œæ•´å€‹éƒ¨é–€å……æ»¿å¹¹å‹ã€‚" },
            { id: 22, word: "å¤§å¹å¤§æ“‚", meaning: "æ¯”å–»å¹å™“æˆ–å®£æšã€‚", example: "ä»–æ•´å¤©å¤§å¹å¤§æ“‚ï¼Œèªªè‡ªå·±èªè­˜å¤šå°‘åäººï¼Œå…¶å¯¦éƒ½æ˜¯å‡çš„ã€‚" },
            { id: 23, word: "å¤§é€†ä¸é“", meaning: "å½¢å®¹è¡Œç‚ºå›é€†ï¼Œé•èƒŒå¸¸ç†ï¼Œéå¸¸ä¸é“å¾·ã€‚", example: "åœ¨å¤ä»£ï¼Œè‡£å­è¬€åè¢«è¦–ç‚ºå¤§é€†ä¸é“çš„ç½ªè¡Œã€‚" },
            { id: 24, word: "å£æ˜¯å¿ƒé", meaning: "æŒ‡å£ä¸­èªªå¾—å¥½è½ï¼Œå¿ƒä¸­æƒ³çš„æ˜¯å¦ä¸€å¥—ã€‚", example: "ä»–é€™å€‹äººå£æ˜¯å¿ƒéï¼Œå˜´ä¸Šèªªæ”¯æŒä½ ï¼ŒèƒŒåœ°è£¡å»æç ´å£ã€‚" },
            { id: 25, word: "å£èœœè…¹åŠ", meaning: "å£ä¸­èªªçš„ç”œç¾å‹•è½ï¼Œå¿ƒä¸­å»å­˜è‘—å®³äººçš„æ­¹å¿µã€‚", example: "é‚£å€‹äººå£èœœè…¹åŠï¼Œç¬‘è£¡è—åˆ€ï¼Œåƒè¬è¦å°å¿ƒã€‚" },
            { id: 26, word: "å£è‹¥æ‡¸æ²³", meaning: "æŒ‡èƒ½è¨€å–„è¾¯ï¼Œèªªè©±æ»”æ»”ä¸çµ•ã€‚", example: "è¾¯è«–æ¯”è³½ä¸­ï¼Œä»–å£è‹¥æ‡¸æ²³ï¼Œèªªå¾—å°æ–¹å•å£ç„¡è¨€ã€‚" },
            { id: 27, word: "åƒéˆä¸€é«®", meaning: "å½¢å®¹å½¢å‹¢å±æ€¥æˆ–æƒ…æ³å±éšªã€‚", example: "å°±åœ¨åƒéˆä¸€é«®ä¹‹éš›ï¼Œæ¶ˆé˜²å“¡è¡é€²ç«å ´æ•‘å‡ºäº†å—å›°çš„å°å­©ã€‚" },
            { id: 28, word: "åƒéŒ˜ç™¾ç…‰", meaning: "å½¢å®¹åšäº‹ç¶“éå¤šæ¬¡åå¾©ï¼Œé”åˆ°ç²¾ç›Šæ±‚ç²¾çš„æ•ˆæœã€‚", example: "é€™ç¯‡æ¼”è¬›ç¨¿ç¶“éåƒéŒ˜ç™¾ç…‰ï¼Œæ¯ä¸€å€‹å­—éƒ½æ°åˆ°å¥½è™•ã€‚" },
            { id: 29, word: "åƒè¼‰é›£é€¢", meaning: "å½¢å®¹é›£å¾—ä¸€é‡çš„æ©Ÿæœƒã€‚", example: "èƒ½å¤ è¦ªçœ¼çœ‹åˆ°æµæ˜Ÿé›¨ï¼ŒçœŸæ˜¯åƒè¼‰é›£é€¢çš„å¥½æ©Ÿæœƒã€‚" },
            { id: 30, word: "åƒè®Šè¬åŒ–", meaning: "è¡¨ç¤ºè®ŠåŒ–å¤šç«¯ã€‚", example: "å¤©ä¸Šçš„é›²å½©åƒè®Šè¬åŒ–ï¼Œæœ‰æ™‚åƒæ£‰èŠ±ï¼Œæœ‰æ™‚åƒé§¿é¦¬ã€‚" },
            { id: 31, word: "äº•åº•ä¹‹è›™", meaning: "å½¢å®¹è¦‹èç‹¹çª„ï¼Œçœ¼å…‰çŸ­æ·ºã€‚", example: "æˆ‘å€‘æ‡‰è©²å¤šè®€æ›¸ã€å¤šå»æ—…è¡Œï¼Œä¸è¦åšäº•åº•ä¹‹è›™ã€‚" },
            { id: 32, word: "æ–‡è³ªå½¬å½¬", meaning: "å½¢å®¹æ‰å¾·å…¼å…·ï¼Œæ‰è¯åŠè¡Œç‚ºå¾ˆæ°ç•¶ã€‚", example: "ä»–ç©¿ä¸Šè¥¿è£ï¼Œæˆ´ä¸Šçœ¼é¡ï¼Œçœ‹èµ·ä¾†æ–‡è³ªå½¬å½¬ã€‚" },
            { id: 33, word: "å¤©å€«ä¹‹æ¨‚", meaning: "æŒ‡äº«å—è¦ªå±¬é–“çš„æ­¡æ¨‚ã€‚", example: "é€±æœ«ä¸€å®¶äººå»å…¬åœ’é‡é¤ï¼Œäº«å—å¤©å€«ä¹‹æ¨‚ã€‚" },
            { id: 34, word: "å¤©é¦¬è¡Œç©º", meaning: "æ¯”å–»æ‰æ€æ•æ·è±ªæ”¾ï¼Œè©©æ–‡æ°£å‹¢è±ªæ”¾ã€‚", example: "é€™ä½ä½œå®¶çš„æƒ³åƒåŠ›å¤©é¦¬è¡Œç©ºï¼Œå¯«å‡ºçš„ç§‘å¹»å°èªªéå¸¸ç²¾å½©ã€‚" },
            { id: 35, word: "äº”åæ­¥ç¬‘ç™¾æ­¥", meaning: "æ¯”å–»è‡ªå·±æœ‰åŒæ¨£ç¼ºé»ï¼Œå»è­ç¬‘åˆ¥äººã€‚", example: "ä½ ä¹Ÿé²åˆ°äº†äº”åˆ†é˜ï¼Œå»ç¬‘æˆ‘é²åˆ°ååˆ†é˜ï¼Œç°¡ç›´æ˜¯äº”åæ­¥ç¬‘ç™¾æ­¥ã€‚" },
            { id: 36, word: "å¤©èŠ±äº‚å¢œ", meaning: "å½¢å®¹èªªè©±è¨€è©å·§å¦™ï¼Œå¤šæŒ‡èª‡å¤§è€Œä¸åˆ‡å¯¦éš›ã€‚", example: "æ¨éŠ·å“¡èªªå¾—å¤©èŠ±äº‚å¢œï¼Œä½†ç”¢å“å¯¦éš›æ•ˆæœå»å¾ˆå·®ã€‚" },
            { id: 37, word: "å¤©ç¶“åœ°ç¾©", meaning: "æŒ‡å­˜åœ¨æ–¼å¤©åœ°é–“ï¼Œä¸å®¹ç½®ç–‘çš„æº–å‰‡å’ŒçœŸç†ã€‚", example: "å­é †çˆ¶æ¯æ˜¯å¤©ç¶“åœ°ç¾©çš„äº‹ï¼Œä¸éœ€è¦ç†ç”±ã€‚" },
            { id: 38, word: "å¤©è¡£ç„¡ç¸«", meaning: "æŒ‡äº‹ç‰©ååˆ†å‘¨å¯†å®Œå–„ï¼Œæ‰¾ä¸å‡ºç ´ç¶»ã€‚", example: "ä»–å€‘çš„é…åˆå¤©è¡£ç„¡ç¸«ï¼Œè¼•é¬†è´å¾—äº†é›™æ‰“æ¯”è³½ã€‚" },
            { id: 39, word: "å¤©çœŸçˆ›æ¼«", meaning: "å½¢å®¹æ€§æƒ…ç´”çœŸã€å¦ç‡ï¼Œæ²’æœ‰é€ ä½œã€‚", example: "çœ‹è‘—å­©å­å€‘å¤©çœŸçˆ›æ¼«çš„ç¬‘å®¹ï¼Œç…©æƒ±éƒ½æ¶ˆå¤±äº†ã€‚" },
            { id: 40, word: "äº”é«”æŠ•åœ°", meaning: "å¼•ç”³å½¢å®¹å°åˆ¥äººååˆ†ä½©æœã€‚", example: "ä»–æ·µåšçš„å­¸è­˜è®“æˆ‘ä½©æœå¾—äº”é«”æŠ•åœ°ã€‚" }
        ];

        const BOARD_SIZE = 28; 
        const TARGET_IDIOMS_COUNT = 20;
        const INITIAL_SCORE = 5000; 
        const BUILD_COST = 300; 
        const MAX_HOUSES = 5;

        // éŸ³æ•ˆ
        const AUDIO_URLS = {
            bgm: "https://cdn.pixabay.com/audio/2022/05/27/audio_1808fbf07a.mp3",
            correct: "https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.m4a",
            wrong: "https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.m4a",
            shatter: "https://assets.mixkit.co/active_storage/sfx/2018/2018-preview.m4a",
            build: "https://assets.mixkit.co/active_storage/sfx/2004/2004-preview.m4a",
        };

        const speak = (text) => {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-HK';
                utterance.rate = 0.8;
                const voices = window.speechSynthesis.getVoices();
                const cantoneseVoice = voices.find(v => v.lang.includes('HK') || v.name.includes('Cantonese'));
                if (cantoneseVoice) utterance.voice = cantoneseVoice;
                window.speechSynthesis.speak(utterance);
            }
        };

        function IdiomMonopolyDuel() {
            const [gameState, setGameState] = useState('menu'); 
            const [sessionIdioms, setSessionIdioms] = useState([]);
            const [boardTiles, setBoardTiles] = useState([]);
            const [studyIndex, setStudyIndex] = useState(0);

            const [turn, setTurn] = useState(1); 
            const [players, setPlayers] = useState({
                1: { pos: 0, score: INITIAL_SCORE, name: 'ç©å®¶ 1', color: 'bg-red-500', bg: 'bg-red-50', border: 'border-red-500', text: 'text-red-700' },
                2: { pos: 0, score: INITIAL_SCORE, name: 'ç©å®¶ 2', color: 'bg-blue-500', bg: 'bg-blue-50', border: 'border-blue-500', text: 'text-blue-700' }
            });
            
            const [diceValue, setDiceValue] = useState(1);
            const [isMoving, setIsMoving] = useState(false);
            const [modalContent, setModalContent] = useState(null); 
            const [currentEvent, setCurrentEvent] = useState(null);
            const [gameLog, setGameLog] = useState(["éŠæˆ²é–‹å§‹ï¼"]);

            const [isMusicPlaying, setIsMusicPlaying] = useState(false);
            const bgmRef = useRef(null);

            useEffect(() => {
                bgmRef.current = new Audio(AUDIO_URLS.bgm);
                bgmRef.current.loop = true;
                bgmRef.current.volume = 0.2;
                return () => {
                    if (bgmRef.current) {
                        bgmRef.current.pause();
                        bgmRef.current = null;
                    }
                };
            }, []);

            useEffect(() => {
                if (bgmRef.current) {
                    if (isMusicPlaying) {
                        bgmRef.current.play().catch(e => console.log("Audio needed interaction:", e));
                    } else {
                        bgmRef.current.pause();
                    }
                }
            }, [isMusicPlaying]);

            // --- ç ´ç”¢æª¢æ¸¬ ---
            useEffect(() => {
                if (gameState === 'game' || gameState === 'menu') {
                    if (players[1].score <= 0) {
                        setGameState('finished');
                    } else if (players[2].score <= 0) {
                        setGameState('finished');
                    }
                }
            }, [players, gameState]);

            const toggleMusic = () => setIsMusicPlaying(!isMusicPlaying);
            const playSfx = (type) => {
                const audio = new Audio(AUDIO_URLS[type]);
                audio.volume = 0.6;
                audio.play().catch(e => console.log("SFX error:", e));
            };
            const addLog = (msg) => setGameLog(prev => [msg, ...prev].slice(0, 3));

            const initGame = () => {
                const shuffled = [...FULL_DATA].sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, TARGET_IDIOMS_COUNT);
                setSessionIdioms(selected);
                
                const newTiles = Array(BOARD_SIZE).fill(null).map((_, i) => ({ id: i, type: 'empty' }));
                newTiles[0] = { id: 0, type: 'start', label: 'èµ·é»' };

                const specialIndices = [3, 7, 11, 15, 19, 23, 27];
                specialIndices.forEach((idx, i) => {
                    newTiles[idx] = {
                        id: idx,
                        type: i % 2 === 0 ? 'chance' : 'fate',
                        label: i % 2 === 0 ? 'æ©Ÿæœƒ' : 'å‘½é‹'
                    };
                });

                let idiomIdx = 0;
                for (let i = 1; i < BOARD_SIZE; i++) {
                    if (newTiles[i].type === 'empty' && idiomIdx < selected.length) {
                        const idiom = selected[idiomIdx];
                        newTiles[i] = { 
                            id: i, 
                            type: 'idiom', 
                            data: idiom,
                            price: 300, 
                            rent: 150,  
                            owner: null,
                            houses: 0
                        };
                        idiomIdx++;
                    }
                }

                setBoardTiles(newTiles);
                setStudyIndex(0);
                setPlayers({
                    1: { pos: 0, score: INITIAL_SCORE, name: 'ç©å®¶ 1', color: 'bg-red-500', bg: 'bg-red-50', border: 'border-red-500', text: 'text-red-700' },
                    2: { pos: 0, score: INITIAL_SCORE, name: 'ç©å®¶ 2', color: 'bg-blue-500', bg: 'bg-blue-50', border: 'border-blue-500', text: 'text-blue-700' }
                });
                setTurn(1);
                setGameLog(["æº–å‚™é–‹å§‹ï¼Œè«‹å…ˆæº«ç¿’ï¼"]);
                setGameState('study');
            };

            const rollDice = async () => {
                if (isMoving || modalContent) return;
                
                const roll = Math.floor(Math.random() * 6) + 1;
                setDiceValue(roll);
                setIsMoving(true);

                let currentPos = players[turn].pos;
                for (let i = 0; i < roll; i++) {
                    await new Promise(r => setTimeout(r, 200));
                    currentPos = (currentPos + 1) % BOARD_SIZE;
                    
                    setPlayers(prev => ({
                        ...prev,
                        [turn]: { ...prev[turn], pos: currentPos }
                    }));

                    if (currentPos === 0) {
                        addLog(`${players[turn].name} ç¶“éèµ·é»ï¼Œ+300åˆ†`);
                        setPlayers(prev => ({
                            ...prev,
                            [turn]: { ...prev[turn], score: prev[turn].score + 300, pos: currentPos }
                        }));
                    }
                }

                setIsMoving(false);
                handleTileEvent(currentPos);
            };

            const generateOptions = (correctData) => {
                const distractors = sessionIdioms
                    .filter(i => i.id !== correctData.id)
                    .sort(() => 0.5 - Math.random())
                    .slice(0, 3);
                return [...distractors, correctData].sort(() => 0.5 - Math.random());
            };

            // æˆ¿å±‹å€ç‡è¨ˆç®—ï¼š0=1x, 1=2x, 2=4x, 3=6x, 4=8x, 5=10x
            const getRentMultiplier = (houses) => {
                if (houses === 0) return 1;
                return houses * 2;
            };

            const calculateChainRent = (centerIndex, ownerId, tiles) => {
                let totalRent = 0;
                let connectedCount = 0;

                const getRent = (t) => {
                    return t.rent * getRentMultiplier(t.houses);
                };

                const centerTile = tiles[centerIndex];
                totalRent += getRent(centerTile);
                connectedCount++;

                let prev = centerIndex - 1;
                while (prev > 0) { 
                    const t = tiles[prev];
                    if (t.type === 'idiom' && t.owner === ownerId) {
                        totalRent += getRent(t);
                        connectedCount++;
                        prev--;
                    } else {
                        break; 
                    }
                }

                let next = centerIndex + 1;
                while (next < BOARD_SIZE) {
                    const t = tiles[next];
                    if (t.type === 'idiom' && t.owner === ownerId) {
                        totalRent += getRent(t);
                        connectedCount++;
                        next++;
                    } else {
                        break;
                    }
                }
                return { totalRent, connectedCount };
            };

            const handleTileEvent = (pos) => {
                const tile = boardTiles[pos];
                
                if (tile.type === 'idiom') {
                    if (tile.owner === null) {
                        const options = generateOptions(tile.data);
                        setCurrentEvent({ ...tile, options, mode: 'buy' });
                        setModalContent('question');

                    } else if (tile.owner !== turn) {
                        const { totalRent, connectedCount } = calculateChainRent(pos, tile.owner, boardTiles);
                        setCurrentEvent({ 
                            ...tile, 
                            mode: 'duel', 
                            currentRent: totalRent,
                            connectedCount 
                        });
                        setModalContent('duel_alert');
                    } else {
                        // å»ºå±‹é‚è¼¯ï¼šä¸Šé™ 5 é–“
                        if (tile.houses < MAX_HOUSES) {
                            if (players[turn].score >= BUILD_COST) {
                                setCurrentEvent({ ...tile, mode: 'build' });
                                setModalContent('build_confirm');
                            } else {
                                addLog("è³‡é‡‘ä¸è¶³ï¼Œç„¡æ³•å‡ç´šæˆ¿å±‹ã€‚");
                                switchTurn();
                            }
                        } else {
                            addLog("æˆ¿å±‹å·²é”é ‚ç´šï¼");
                            switchTurn();
                        }
                    }

                } else if (tile.type === 'chance' || tile.type === 'fate') {
                    const isChance = tile.type === 'chance';
                    const points = isChance ? 300 : -200; // åŠ å¤§æ•¸å€¼å¢åŠ æ³¢å‹•
                    const texts = isChance 
                        ? ["æ’¿åˆ°æˆèªç§˜ç±ï¼", "è€å¸«ç¨±è®šä½ ï¼", "å¹¸é‹ä¸­çï¼"]
                        : ["ä¸Šèª²ç™¼ç™½æ—¥å¤¢ã€‚", "å¿˜è¨˜å¸¶åŠŸèª²ã€‚", "æ¸¬é©—ä¸åˆæ ¼ã€‚"];
                    
                    const text = texts[Math.floor(Math.random() * texts.length)];
                    // ä¿®æ­£ï¼šè£œä¸Š mode: 'event'ï¼Œé¿å… handleAnswer å‡ºéŒ¯
                    setCurrentEvent({ title: isChance ? "æ©Ÿæœƒ" : "å‘½é‹", text, points, mode: 'event' });
                    setModalContent('event');
                } else {
                    switchTurn();
                }
            };

            const startDuelQuestion = () => {
                const tile = currentEvent;
                const options = generateOptions(tile.data);
                setCurrentEvent({ ...tile, options, mode: 'duel' }); 
                setModalContent('question');
            };

            const handleBuildConfirm = () => {
                setPlayers(prev => ({
                    ...prev,
                    [turn]: { ...prev[turn], score: prev[turn].score - BUILD_COST }
                }));
                setBoardTiles(prev => prev.map(t => 
                    t.id === currentEvent.id ? { ...t, houses: t.houses + 1 } : t
                ));
                addLog(`${players[turn].name} å‡ç´šäº†æˆ¿å±‹ï¼(Lv.${currentEvent.houses + 1})`);
                speak("å‡ç´šæˆåŠŸï¼");
                playSfx('build');
                setModalContent(null);
                switchTurn();
            };

            const handleAnswer = (selectedId) => {
                // ä¿®æ­£ï¼šç§»é™¤é ‚å±¤çš„ isCorrect åˆ¤æ–·ï¼Œé¿å…åœ¨ 'event' æ¨¡å¼ä¸‹å›  data ç‚º undefined è€Œå ±éŒ¯
                
                if (currentEvent.mode === 'buy') {
                    const isCorrect = selectedId === currentEvent.data.id;
                    if (isCorrect) {
                        addLog(`${players[turn].name} è²·åœ°æˆåŠŸï¼`);
                        setBoardTiles(prev => prev.map(t => 
                            t.id === currentEvent.id ? { ...t, owner: turn } : t
                        ));
                        setPlayers(prev => ({
                            ...prev,
                            [turn]: { ...prev[turn], score: prev[turn].score + 100 }
                        }));
                        speak("ç­”å°äº†ï¼");
                        playSfx('correct');
                        setModalContent('correct_buy');
                    } else {
                        addLog(`${players[turn].name} è²·åœ°å¤±æ•—ã€‚`);
                        playSfx('wrong');
                        setModalContent('wrong_buy');
                    }
                } else if (currentEvent.mode === 'duel') {
                    const isCorrect = selectedId === currentEvent.data.id;
                    const opponent = turn === 1 ? 2 : 1;
                    const baseRent = currentEvent.currentRent;
                    let actualRent = 0;
                    let resultType = '';

                    if (isCorrect) {
                        actualRent = baseRent;
                        resultType = 'duel_win';
                        speak("é˜²ç¦¦æˆåŠŸï¼");
                        playSfx('correct');
                        addLog(`é˜²ç¦¦æˆåŠŸï¼æ”¯ä»˜åŸåƒ¹ $${actualRent}`);
                    } else {
                        actualRent = baseRent * 2;
                        resultType = 'duel_lose';
                        playSfx('shatter'); 
                        addLog(`é˜²ç¦¦å¤±æ•—ï¼é›™å€ç½°æ¬¾ $${actualRent}`);
                    }

                    setPlayers(prev => ({
                        ...prev,
                        [turn]: { ...prev[turn], score: prev[turn].score - actualRent },
                        [opponent]: { ...prev[opponent], score: prev[opponent].score + actualRent }
                    }));

                    setCurrentEvent(prev => ({ ...prev, actualRent }));
                    setModalContent(resultType);
                } else if (currentEvent.mode === 'event') {
                    setPlayers(prev => ({
                        ...prev,
                        [turn]: { ...prev[turn], score: prev[turn].score + currentEvent.points }
                    }));
                    setModalContent(null);
                    switchTurn();
                }
            };

            const switchTurn = () => {
                setTurn(prev => prev === 1 ? 2 : 1);
            };

            const calculateTotal = (playerId) => {
                const cash = players[playerId].score;
                const propertyValue = boardTiles
                    .filter(t => t.owner === parseInt(playerId))
                    .reduce((sum, t) => sum + t.price + (t.houses * BUILD_COST), 0);
                return cash + propertyValue;
            };

            // --- ä»‹é¢ ---
            const MenuScreen = () => (
                <div className="flex flex-col items-center justify-center min-h-[500px] p-8 space-y-8 bg-white rounded-xl shadow-2xl border-4 border-indigo-100 text-center animate-fade-in relative">
                    <button 
                        onClick={toggleMusic}
                        className={`absolute top-4 right-4 p-2 rounded-full ${isMusicPlaying ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-500'} transition-colors`}
                    >
                        {isMusicPlaying ? <Icons.Music size={24} /> : <Icons.VolumeX size={24} />}
                    </button>

                    <div className="flex gap-4 mb-4">
                        <Icons.Home size={64} className="text-indigo-600" />
                    </div>
                    <div>
                        <h1 className="text-4xl font-black text-indigo-900 tracking-tight mb-2">æˆèªå¤§å¯Œç¿ï¼šçµ‚æ¥µå°æ±º</h1>
                        <p className="text-xl text-gray-500 font-medium">ç ´ç”¢æ®Šæ­»æˆ°ãƒ»äº”ç´šè±ªå®…ãƒ»é€£é–æ”»é˜²</p>
                    </div>
                    <div className="bg-orange-50 p-6 rounded-xl text-left max-w-md w-full border border-orange-200">
                        <h3 className="font-bold text-orange-800 flex items-center gap-2 mb-3">
                            <Icons.ShieldAlert size={20}/> éŠæˆ²è¦å‰‡ (v4.0)ï¼š
                        </h3>
                        <ul className="list-disc list-inside text-sm text-gray-700 space-y-2 font-medium">
                            <li><span className="text-red-600 font-bold">ç ´ç”¢å³è¼¸</span>ï¼šé‡‘éŒ¢æ­¸é›¶ (&le;0) ç«‹å³æˆ°æ•—ã€‚</li>
                            <li><span className="text-indigo-600 font-bold">äº”ç´šåœ°ç”¢</span>ï¼šæ¯é–“å±‹åŠ  2 å€ç§Ÿé‡‘ï¼Œæœ€é«˜ 10 å€ï¼</li>
                            <li><span className="text-blue-600 font-bold">é€£é–è¨ˆè²»</span>ï¼šç›¸é€£åœ°ç›¤ç§Ÿé‡‘ç–ŠåŠ è¨ˆç®—ã€‚</li>
                            <li>é˜²ç¦¦å¤±æ•—ç½°é›™å€ï¼Œæœ€é«˜å¯é” <span className="font-bold text-red-600">20å€</span> ç§Ÿé‡‘ï¼</li>
                        </ul>
                    </div>
                    <button 
                        onClick={() => {
                            initGame();
                            if (!isMusicPlaying) toggleMusic(); 
                        }}
                        className="w-full max-w-xs px-8 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-2xl font-bold text-xl shadow-xl hover:scale-105 transition-transform"
                    >
                        é–‹å§‹å°æˆ°
                    </button>
                </div>
            );

            const StudyScreen = () => {
                const item = sessionIdioms[studyIndex];
                return (
                    <div className="flex flex-col h-full bg-white rounded-xl shadow-xl overflow-hidden max-w-2xl mx-auto">
                        <div className="bg-indigo-600 text-white p-4 flex justify-between items-center">
                            <span className="font-bold flex items-center gap-2"><Icons.BookOpen/> æˆ°å‰ç‰¹è¨“ (å…±20é¡Œ)</span>
                            <span className="bg-indigo-800 px-3 py-1 rounded-full text-xs font-mono">{studyIndex + 1} / {TARGET_IDIOMS_COUNT}</span>
                        </div>
                        <div className="flex-1 p-8 flex flex-col items-center justify-center text-center space-y-6">
                            <div className="group relative cursor-pointer" onClick={() => speak(item.word)}>
                                <div className="text-5xl font-black text-gray-800 mb-2 group-hover:text-indigo-600 transition-colors">{item.word}</div>
                                <div className="absolute top-0 -right-8 text-indigo-400 opacity-50 group-hover:opacity-100 animate-pulse"><Icons.Volume2 size={24} /></div>
                            </div>
                            <div className="text-xl text-gray-600 font-medium leading-relaxed bg-gray-50 p-6 rounded-xl border border-gray-100 w-full">{item.meaning}</div>
                            <div className="text-sm text-gray-500 italic bg-yellow-50 p-4 rounded-lg w-full">ä¾‹ï¼š{item.example}</div>
                        </div>
                        <div className="p-6 bg-gray-50 flex justify-between">
                            <button disabled={studyIndex === 0} onClick={() => setStudyIndex(i => i - 1)} className="px-6 py-2 rounded-lg font-bold text-gray-500 hover:bg-gray-200 disabled:opacity-30 transition">ä¸Šä¸€å€‹</button>
                            {studyIndex < TARGET_IDIOMS_COUNT - 1 ? (
                                <button onClick={() => setStudyIndex(i => i + 1)} className="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition flex items-center gap-2">ä¸‹ä¸€å€‹ <Icons.ArrowRight size={18} /></button>
                            ) : (
                                <button onClick={() => setGameState('game')} className="px-8 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition shadow-lg animate-bounce flex items-center gap-2">é€²å…¥æˆ°å ´ <Icons.Swords size={18} /></button>
                            )}
                        </div>
                    </div>
                );
            };

            const RenderBoard = () => {
                const getGridPos = (index) => {
                    if (index <= 7) return { row: 1, col: index + 1 };
                    if (index <= 14) return { row: index - 6, col: 8 };
                    if (index <= 21) return { row: 8, col: 8 - (index - 14) };
                    return { row: 8 - (index - 21), col: 1 };
                };

                return (
                    <div className="grid grid-cols-8 grid-rows-8 gap-1 w-full max-w-3xl aspect-square mx-auto bg-slate-100 p-2 rounded-xl shadow-inner border-4 border-slate-200 relative select-none">
                        <button 
                            onClick={toggleMusic}
                            className={`absolute top-2 right-2 z-20 p-1.5 rounded-full shadow-md ${isMusicPlaying ? 'bg-white text-indigo-600' : 'bg-gray-200 text-gray-500'} opacity-80 hover:opacity-100`}
                        >
                            {isMusicPlaying ? <Icons.Music size={16} /> : <Icons.VolumeX size={16} />}
                        </button>

                        <div className="col-start-2 col-end-8 row-start-2 row-end-8 bg-white rounded-xl shadow-sm flex flex-col p-4 z-10 overflow-hidden">
                            <div className="flex gap-2 mb-4">
                                {[1, 2].map(pid => (
                                    <div key={pid} className={`flex-1 p-3 rounded-xl border-2 transition-all ${players[pid].bg} ${players[pid].border} ${turn === pid ? 'ring-4 ring-yellow-400 scale-105 shadow-md' : 'opacity-80'}`}>
                                        <div className={`font-bold ${players[pid].text} flex justify-between`}>
                                            <span>{players[pid].name}</span>
                                            {turn === pid && <span className="text-xs bg-yellow-400 text-yellow-900 px-1 rounded">å›åˆ</span>}
                                        </div>
                                        <div className={`text-2xl font-black ${players[pid].score <= 0 ? 'text-red-600 animate-pulse' : 'text-gray-800'}`}>${players[pid].score}</div>
                                        <div className="text-xs text-gray-500 flex items-center gap-1">
                                            åœ°çš®: {boardTiles.filter(t=>t.owner===pid).length}
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="bg-gray-50 rounded-lg p-2 h-20 overflow-y-auto mb-4 text-xs text-gray-600 border border-gray-100 font-mono">
                                {gameLog.map((log, i) => <div key={i} className={i===0?'font-bold text-black':''}>{i===0?'> ':''}{log}</div>)}
                            </div>
                            <div className="flex-1 flex items-center justify-center">
                                <button onClick={rollDice} disabled={isMoving || modalContent !== null} className={`w-24 h-24 rounded-2xl shadow-xl flex flex-col items-center justify-center text-white font-bold transition-all ${turn === 1 ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'} ${(isMoving || modalContent) ? 'opacity-50 cursor-not-allowed' : 'hover:scale-110 active:scale-95'}`}>
                                    {isMoving ? <div className="animate-spin text-3xl">ğŸ²</div> : <><Icons.Dices size={32}/><span className="mt-1">æ“²éª°å­</span></>}
                                </button>
                                {diceValue > 0 && !isMoving && <div className="ml-4 font-bold text-gray-400 text-xl">é»æ•¸: {diceValue}</div>}
                            </div>
                        </div>

                        {boardTiles.map((tile, i) => {
                            const pos = getGridPos(i);
                            const p1Here = players[1].pos === i;
                            const p2Here = players[2].pos === i;
                            
                            let bgClass = "bg-white";
                            let borderClass = "border-gray-200";
                            if (tile.type === 'start') bgClass = "bg-yellow-100";
                            else if (tile.type === 'chance') bgClass = "bg-orange-100";
                            else if (tile.type === 'fate') bgClass = "bg-purple-100";
                            else if (tile.owner === 1) { bgClass = "bg-red-100"; borderClass = "border-red-400"; }
                            else if (tile.owner === 2) { bgClass = "bg-blue-100"; borderClass = "border-blue-400"; }

                            return (
                                <div key={i} className={`relative flex flex-col items-center justify-center text-center rounded border text-[8px] md:text-[10px] font-bold overflow-hidden transition-colors ${bgClass} ${borderClass}`} style={{ gridRow: pos.row, gridColumn: pos.col }}>
                                    {tile.type === 'idiom' ? (
                                        <>
                                            <span className={`leading-tight z-10 ${tile.owner ? (tile.owner === 1 ? 'text-red-800' : 'text-blue-800') : 'text-gray-600'}`}>{tile.data.word}</span>
                                            {tile.owner && (
                                                <div className={`absolute top-0 right-0 p-0.5 text-[7px] text-white rounded-bl ${tile.owner === 1 ? 'bg-red-500' : 'bg-blue-500'}`}>
                                                    ${tile.rent * getRentMultiplier(tile.houses)}
                                                </div>
                                            )}
                                            {/* æˆ¿å±‹é¡¯ç¤ºå€åŸŸ (æœ€å¤š5é–“) */}
                                            <div className="absolute top-0 left-0 flex flex-wrap w-full p-0.5 gap-[1px]">
                                                {tile.houses === 5 ? (
                                                    <div className="w-full text-center"><Icons.Crown size={12} className="inline text-yellow-500 fill-yellow-500" /></div>
                                                ) : (
                                                    Array.from({length: tile.houses}).map((_, hi) => (
                                                        <Icons.Home key={hi} size={6} className={tile.owner === 1 ? 'text-red-600 fill-red-600' : 'text-blue-600 fill-blue-600'} />
                                                    ))
                                                )}
                                            </div>
                                        </>
                                    ) : (
                                        <span className="opacity-60">{tile.label}</span>
                                    )}
                                    <div className="absolute bottom-0 w-full flex justify-center gap-1 pb-0.5">
                                        {p1Here && <div className="w-4 h-4 md:w-6 md:h-6 bg-red-500 rounded-full border-2 border-white shadow-md z-20"></div>}
                                        {p2Here && <div className="w-4 h-4 md:w-6 md:h-6 bg-blue-500 rounded-full border-2 border-white shadow-md z-20"></div>}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                );
            };

            const Modal = () => {
                if (!modalContent) return null;
                const isRed = turn === 1;
                const themeColor = isRed ? 'red' : 'blue';

                const WrongExplanation = () => (
                    <div className="mt-4 bg-red-50 p-4 rounded-xl border border-red-200 text-left">
                        <div className="text-red-800 font-bold mb-1 flex items-center gap-2">
                            <Icons.BookOpen size={16}/> æ­£ç¢ºç­”æ¡ˆï¼š{currentEvent.data.word}
                        </div>
                        <div className="text-gray-600 text-sm mb-2">{currentEvent.data.meaning}</div>
                        <div className="text-gray-500 text-xs italic bg-white p-2 rounded border border-red-100">
                            ä¾‹ï¼š{currentEvent.data.example}
                        </div>
                    </div>
                );

                return (
                    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 backdrop-blur-sm animate-fade-in">
                        <div className={`bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden border-4 border-${themeColor}-200`}>
                            {/* å»ºå±‹ç¢ºèª */}
                            {modalContent === 'build_confirm' && (
                                <div className="p-8 text-center bg-indigo-50">
                                    <Icons.Home size={64} className="mx-auto text-indigo-500 mb-4" />
                                    <h3 className="text-2xl font-black text-indigo-900 mb-2">å‡ç´šåœ°ç›¤ï¼Ÿ</h3>
                                    <p className="text-gray-700 mb-6">
                                        èŠ±è²» <span className="font-bold text-red-600">${BUILD_COST}</span> å»ºé€ ä¸€é–“æˆ¿å±‹ï¼Ÿ<br/>
                                        ç•¶å‰æˆ¿å±‹: {currentEvent.houses} / {MAX_HOUSES}<br/>
                                        <span className="text-sm text-gray-500">æ¯ç´šæå‡ 2 å€ç§Ÿé‡‘ï¼</span>
                                    </p>
                                    <div className="flex gap-4">
                                        <button onClick={() => { setModalContent(null); switchTurn(); }} className="flex-1 py-3 bg-gray-300 text-gray-700 rounded-xl font-bold hover:bg-gray-400">ä¸äº†</button>
                                        <button onClick={handleBuildConfirm} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg">ç¢ºèªå»ºé€ </button>
                                    </div>
                                </div>
                            )}

                            {/* æ©Ÿæœƒ/å‘½é‹äº‹ä»¶ */}
                            {modalContent === 'event' && (
                                <div className="p-8 text-center bg-white">
                                    <div className="mb-4 flex justify-center">
                                        <Icons.Dices size={48} className="text-indigo-500"/>
                                    </div>
                                    <h3 className="text-2xl font-bold mb-4 text-gray-800">{currentEvent.title}</h3>
                                    <p className="text-lg text-gray-600 mb-6">
                                        {currentEvent.text} <br/>
                                        <span className={`font-bold ${currentEvent.points > 0 ? 'text-green-600' : 'text-red-600'}`}>
                                            {currentEvent.points > 0 ? '+' : ''}{currentEvent.points} åˆ†
                                        </span>
                                    </p>
                                    <button 
                                        onClick={() => handleAnswer(null)} 
                                        className={`w-full py-3 bg-${themeColor}-600 text-white rounded-xl font-bold hover:bg-${themeColor}-700`}
                                    >
                                        ç¢ºå®š
                                    </button>
                                </div>
                            )}

                            {/* è¸©ä¸­å°æ‰‹è­¦å‘Š */}
                            {modalContent === 'duel_alert' && (
                                <div className="p-8 text-center bg-red-50">
                                    <Icons.ShieldAlert size={64} className="mx-auto text-red-500 mb-4 animate-pulse" />
                                    <h3 className="text-2xl font-black text-red-800 mb-2">å±éšªï¼è¸©ä¸­å°æ‰‹åœ°ç›¤ï¼</h3>
                                    <div className="text-gray-700 mb-4">
                                        <p>é€™æ˜¯ <strong>{players[isRed?2:1].name}</strong> çš„é ˜åœ°ã€‚</p>
                                        {currentEvent.connectedCount > 1 && (
                                            <div className="inline-flex items-center gap-1 bg-red-100 text-red-800 px-2 py-1 rounded mt-2 font-bold">
                                                <Icons.Link size={16}/> {currentEvent.connectedCount} é€£é–åœ°ç›¤ï¼
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="bg-white p-4 rounded-xl border border-red-200 mb-6 text-sm text-left space-y-2">
                                        <div className="flex items-center justify-between gap-2 font-bold text-lg border-b pb-2">
                                            <span>é€£é–ç¸½ç§Ÿé‡‘:</span>
                                            <span className="text-red-600">${currentEvent.currentRent}</span>
                                        </div>
                                        <div className="flex items-center gap-2 text-green-700 pt-2"><Icons.ShieldCheck size={16}/> ç­”å°: æ”¯ä»˜åŸåƒ¹ (${currentEvent.currentRent})</div>
                                        <div className="flex items-center gap-2 text-red-700"><Icons.ShieldAlert size={16}/> ç­”éŒ¯: é›™å€ç½°æ¬¾ (${currentEvent.currentRent*2})</div>
                                    </div>
                                    <button onClick={startDuelQuestion} className="w-full py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 shadow-lg">æ¥å—æŒ‘æˆ°</button>
                                </div>
                            )}

                            {/* å•é¡Œç•Œé¢ */}
                            {modalContent === 'question' && (
                                <div className="p-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <span className={`px-3 py-1 rounded-full text-xs font-bold text-white bg-${themeColor}-500`}>{players[turn].name} çš„å›åˆ</span>
                                        <span className="text-gray-400 text-xs font-bold">{currentEvent.mode === 'buy' ? 'ä½”é ˜æ¨¡å¼' : 'é˜²ç¦¦æ¨¡å¼'}</span>
                                    </div>
                                    <div className="mb-6">
                                        <p className="text-gray-500 text-xs mb-2">æˆèªæ„æ€ï¼š</p>
                                        <div className="text-lg font-bold text-gray-800 bg-gray-50 p-4 rounded-lg border-l-4 border-indigo-500">{currentEvent.data.meaning}</div>
                                    </div>
                                    <div className="grid gap-3">
                                        {currentEvent.options.map((opt, idx) => (
                                            <button 
                                                key={idx} 
                                                onClick={() => handleAnswer(opt.id)} 
                                                className="p-4 rounded-xl border-2 border-gray-200 bg-white hover:bg-gray-50 hover:border-gray-300 text-left font-bold text-gray-700 active:scale-98 transition-all"
                                            >
                                                {opt.word}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* çµæœåé¥‹ */}
                            {['correct_buy', 'wrong_buy', 'duel_win', 'duel_lose'].includes(modalContent) && (
                                <div className="p-8 text-center bg-white">
                                    <div className="mb-4 flex justify-center">
                                        {modalContent === 'correct_buy' && <Icons.Star size={48} className="text-yellow-400"/>}
                                        {modalContent === 'wrong_buy' && <Icons.Trophy size={48} className="text-gray-300"/>}
                                        {modalContent === 'duel_win' && <Icons.ShieldCheck size={48} className="text-green-500"/>}
                                        {modalContent === 'duel_lose' && <Icons.ShieldAlert size={48} className="text-red-500"/>}
                                    </div>
                                    <h3 className="text-2xl font-bold mb-2 text-gray-800">
                                        {modalContent === 'correct_buy' && "ä½”é ˜æˆåŠŸï¼"}
                                        {modalContent === 'wrong_buy' && "ä½”é ˜å¤±æ•—..."}
                                        {modalContent === 'duel_win' && "é˜²ç¦¦æˆåŠŸï¼"}
                                        {modalContent === 'duel_lose' && "é˜²ç¦¦å¤±æ•—ï¼"}
                                    </h3>
                                    
                                    <div className="text-gray-600 mb-6">
                                        {modalContent === 'duel_win' && `é˜²ç¦¦æˆåŠŸï¼æ”¯ä»˜åŸåƒ¹ç§Ÿé‡‘ $${currentEvent.actualRent}ã€‚`}
                                        {modalContent === 'duel_lose' && `é˜²ç¦¦å¤±æ•—ï¼ä½ éœ€è¦æ”¯ä»˜é›™å€ç§Ÿé‡‘ $${currentEvent.actualRent}ï¼`}
                                        {modalContent === 'correct_buy' && "ç²å¾—åœ°çš®åŠçå‹µï¼"}
                                        
                                        {(modalContent === 'wrong_buy' || modalContent === 'duel_lose') && <WrongExplanation />}
                                    </div>

                                    <button onClick={() => { setModalContent(null); switchTurn(); }} className={`w-full py-3 bg-${themeColor}-600 text-white rounded-xl font-bold hover:bg-${themeColor}-700`}>ç¢ºå®š</button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const FinishedScreen = () => {
                const winner = players[1].score <= 0 ? 2 : (players[2].score <= 0 ? 1 : (calculateTotal(1) > calculateTotal(2) ? 1 : 2));
                const reason = players[1].score <= 0 ? "ç©å®¶ 1 ç ´ç”¢" : (players[2].score <= 0 ? "ç©å®¶ 2 ç ´ç”¢" : "åœ°çš®å”®ç½„");

                return (
                    <div className="flex flex-col items-center justify-center min-h-[500px] p-8 text-center space-y-6 bg-white rounded-xl shadow-lg border-4 border-yellow-200">
                        <Icons.Crown size={80} className="text-yellow-400 drop-shadow-lg" />
                        <h2 className="text-4xl font-black text-indigo-900">éŠæˆ²çµæŸï¼</h2>
                        <p className="text-xl text-red-500 font-bold">{reason}</p>
                        
                        <div className="flex gap-4 w-full max-w-lg justify-center mt-4">
                            {[1, 2].map(pid => (
                                <div key={pid} className={`flex-1 p-4 rounded-xl border-4 ${winner === pid ? 'border-yellow-400 bg-yellow-50 scale-105' : 'border-gray-100 bg-gray-50 opacity-50'}`}>
                                    <div className={`text-xl font-bold ${pid===1?'text-red-700':'text-blue-700'}`}>ç©å®¶ {pid}</div>
                                    <div className={`text-3xl font-black ${players[pid].score <= 0 ? 'text-red-500' : 'text-gray-800'}`}>${players[pid].score <= 0 ? 0 : calculateTotal(pid)}</div>
                                    <div className="text-xs text-gray-500">{players[pid].score <= 0 ? "å·²ç ´ç”¢" : "ç¸½è³‡ç”¢"}</div>
                                </div>
                            ))}
                        </div>
                        <div className="text-2xl font-bold text-indigo-600 mt-6 animate-bounce">
                            æ­å–œ {players[winner].name} ç²å‹ï¼
                        </div>
                        <button onClick={initGame} className="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-indigo-700 transition">å†ä¾†ä¸€å±€</button>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-slate-100 py-4 px-2 md:py-8 font-sans flex flex-col items-center">
                    <div className="w-full max-w-4xl">
                        {gameState === 'menu' && <MenuScreen />}
                        {gameState === 'study' && <StudyScreen />}
                        {gameState === 'game' && <RenderBoard />}
                        {gameState === 'finished' && <FinishedScreen />}
                    </div>
                    <Modal />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<IdiomMonopolyDuel />);
    </script>
</body>
</html>
