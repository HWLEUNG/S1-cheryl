import React, { useState, useEffect } from 'react';
import { BookOpen, RefreshCw, Trophy, HelpCircle, X, CheckCircle, Brain, Volume2, ArrowRight, Star, Lock } from 'lucide-react';

// 數據來源：根據用戶上傳的附件整理 (第10至40項)
const FULL_DATA = [
  { id: 10, word: "一葉知秋", meaning: "形容從微小的事物便推斷出結果。" },
  { id: 11, word: "一落千丈", meaning: "地位名聲或事物境況急速下滑。" },
  { id: 12, word: "入木三分", meaning: "比喻議論見解非常深刻、精闢。" },
  { id: 13, word: "九死一生", meaning: "形容處境非常危險，死裏逃生。" },
  { id: 14, word: "八面威風", meaning: "形容人或事氣勢雄壯，威風凜凜。" },
  { id: 15, word: "人傑地靈", meaning: "形容秀麗的地方，孕育出傑出人才。" },
  { id: 16, word: "力不從心", meaning: "指內心想做事，但能力不足。" },
  { id: 17, word: "三思而行", meaning: "喻做事情前要多次深入考慮才實行。" },
  { id: 18, word: "亡羊補牢", meaning: "喻犯錯後，立即想辦法補救，以防重蹈覆轍。" },
  { id: 19, word: "大義滅親", meaning: "維護正義，不徇私，不袒護子女親族。" },
  { id: 20, word: "大發雷霆", meaning: "形容非常憤怒，大發脾氣。" },
  { id: 21, word: "上行下效", meaning: "形容上級怎樣做，下級跟著仿效。" },
  { id: 22, word: "大吹大擂", meaning: "比喻吹噓或宣揚。" },
  { id: 23, word: "大逆不道", meaning: "形容行為叛逆，違背常理，非常不道德。" },
  { id: 24, word: "口是心非", meaning: "指口中說得好聽，心中想的是另一套。" },
  { id: 25, word: "口蜜腹劍", meaning: "口中說的甜美動聽，心中卻存著害人的歹念。" },
  { id: 26, word: "口若懸河", meaning: "指能言善辯，說話滔滔不絕。" },
  { id: 27, word: "千鈞一髮", meaning: "形容形勢危急或情況危險。" },
  { id: 28, word: "千錘百煉", meaning: "形容做事經過多次反復，達到精益求精的效果。" },
  { id: 29, word: "千載難逢", meaning: "形容難得一遇的機會。" },
  { id: 30, word: "千變萬化", meaning: "表示變化多端。" },
  { id: 31, word: "井底之蛙", meaning: "形容見聞狹窄，眼光短淺。" },
  { id: 32, word: "文質彬彬", meaning: "形容才德兼具，才華及行為很恰當。" },
  { id: 33, word: "天倫之樂", meaning: "指享受親屬間的歡樂。" },
  { id: 34, word: "天馬行空", meaning: "比喻才思敏捷豪放，詩文氣勢豪放。" },
  { id: 35, word: "五十步笑百步", meaning: "比喻自己有同樣缺點，卻譏笑別人。" },
  { id: 36, word: "天花亂墜", meaning: "形容說話言詞巧妙，多指誇大而不切實際。" },
  { id: 37, word: "天經地義", meaning: "指存在於天地間，不容置疑的準則和真理。" },
  { id: 38, word: "天衣無縫", meaning: "指事物十分周密完善，找不出破綻。" },
  { id: 39, word: "天真爛漫", meaning: "形容性情純真、坦率，沒有造作。" },
  { id: 40, word: "五體投地", meaning: "引申形容對別人十分佩服。" }
];

// 遊戲配置
const PAIRS_PER_GAME = 10; // 每次玩 10 對 (20 張卡)

export default function IdiomChallengeV2() {
  const [gameState, setGameState] = useState('menu'); // menu, level1 (study), level2 (game), finished
  const [sessionData, setSessionData] = useState([]); // 保存當前這一局隨機選出的 10 個成語
  const [currentStudyIndex, setCurrentStudyIndex] = useState(0);
  
  const [cards, setCards] = useState([]);
  const [flipped, setFlipped] = useState([]);
  const [solved, setSolved] = useState([]);
  const [disabled, setDisabled] = useState(false);
  const [moves, setMoves] = useState(0);

  // 初始化一個新的挑戰循環
  const initSession = () => {
    // 1. 隨機選取 10 個成語
    const shuffledData = [...FULL_DATA].sort(() => 0.5 - Math.random());
    const selectedIdioms = shuffledData.slice(0, PAIRS_PER_GAME);
    
    setSessionData(selectedIdioms);
    setCurrentStudyIndex(0);
    
    // 重置遊戲狀態
    setSolved([]);
    setMoves(0);
    setFlipped([]);
    
    // 進入第一關
    setGameState('level1');
  };

  // 進入第二關 (遊戲模式)
  const startLevel2 = () => {
    // 使用 sessionData (剛剛溫習過的那 10 個) 建立卡片
    const gameCards = [];
    sessionData.forEach(item => {
      gameCards.push({
        id: `word-${item.id}`,
        content: item.word,
        pairId: item.id,
        type: 'word',
        fullData: item
      });
      gameCards.push({
        id: `meaning-${item.id}`,
        content: item.meaning,
        pairId: item.id,
        type: 'meaning',
        fullData: item
      });
    });

    // 洗牌
    setCards(gameCards.sort(() => 0.5 - Math.random()));
    setGameState('level2');
  };

  // 語音朗讀
  const speak = (text) => {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'zh-HK';
      utterance.rate = 0.8;
      const voices = window.speechSynthesis.getVoices();
      const cantoneseVoice = voices.find(v => v.lang.includes('HK') || v.name.includes('Cantonese'));
      if (cantoneseVoice) utterance.voice = cantoneseVoice;
      window.speechSynthesis.speak(utterance);
    }
  };

  // 處理卡片點擊
  const handleCardClick = (id) => {
    if (disabled || flipped.includes(id) || solved.includes(cards.find(c => c.id === id).pairId)) return;

    const newFlipped = [...flipped, id];
    setFlipped(newFlipped);

    if (newFlipped.length === 2) {
      setDisabled(true);
      setMoves(prev => prev + 1);
      
      const card1 = cards.find(c => c.id === newFlipped[0]);
      const card2 = cards.find(c => c.id === newFlipped[1]);

      if (card1.pairId === card2.pairId) {
        setSolved([...solved, card1.pairId]);
        setFlipped([]);
        setDisabled(false);
      } else {
        setTimeout(() => {
          setFlipped([]);
          setDisabled(false);
        }, 1200);
      }
    }
  };

  // 檢查是否通關
  useEffect(() => {
    if (solved.length === PAIRS_PER_GAME && gameState === 'level2') {
      setTimeout(() => setGameState('finished'), 800);
    }
  }, [solved, gameState]);

  // --- 畫面組件 ---

  const MenuScreen = () => (
    <div className="flex flex-col items-center justify-center min-h-[500px] p-8 bg-white rounded-xl shadow-lg animate-fade-in text-center">
      <div className="mb-6">
        <span className="inline-block p-3 bg-indigo-100 rounded-full text-indigo-600 mb-4">
          <Brain size={48} />
        </span>
        <h1 className="text-4xl font-bold text-gray-800 mb-2">成語闖關挑戰</h1>
        <p className="text-gray-500">中一成語選讀 (No. 10-40)</p>
      </div>

      <div className="grid gap-6 w-full max-w-md">
        <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 flex items-start gap-3 text-left">
          <div className="bg-blue-200 p-2 rounded-lg text-blue-700 font-bold shrink-0">1</div>
          <div>
            <h3 className="font-bold text-blue-900">第一關：溫習室</h3>
            <p className="text-sm text-blue-700">隨機抽選 {PAIRS_PER_GAME} 個成語，先聽讀、記解釋。</p>
          </div>
        </div>
        
        <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 flex items-start gap-3 text-left opacity-75">
          <div className="bg-indigo-200 p-2 rounded-lg text-indigo-700 font-bold shrink-0">2</div>
          <div>
            <h3 className="font-bold text-indigo-900">第二關：記憶戰</h3>
            <p className="text-sm text-indigo-700">運用剛剛溫習的記憶，完成配對挑戰。</p>
          </div>
        </div>

        <button 
          onClick={initSession}
          className="mt-4 flex items-center justify-center gap-2 px-8 py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold text-xl shadow-lg transition-transform hover:scale-105"
        >
          開始挑戰 <ArrowRight size={24} />
        </button>
      </div>
    </div>
  );

  const Level1Screen = () => {
    const item = sessionData[currentStudyIndex];
    
    return (
      <div className="flex flex-col h-[600px] bg-white rounded-xl shadow-lg overflow-hidden">
        {/* 頂部進度條 */}
        <div className="bg-blue-600 text-white p-4 flex justify-between items-center">
          <div className="flex items-center gap-2 font-bold">
            <BookOpen size={20} /> 第一關：鞏固溫習
          </div>
          <div className="text-sm bg-blue-500 px-3 py-1 rounded-full">
            {currentStudyIndex + 1} / {PAIRS_PER_GAME}
          </div>
        </div>

        {/* 內容區 */}
        <div className="flex-1 flex flex-col items-center justify-center p-8 text-center space-y-8 animate-fade-in">
          <div className="space-y-4">
            <div className="text-sm text-gray-400 font-bold tracking-widest">請點擊成語朗讀</div>
            <button 
              onClick={() => speak(item.word)}
              className="relative group cursor-pointer transition-transform active:scale-95"
            >
              <h2 className="text-6xl font-black text-gray-800 mb-2 group-hover:text-blue-600 transition-colors">
                {item.word}
              </h2>
              <div className="absolute -right-12 top-1/2 -translate-y-1/2 text-blue-400 opacity-50 group-hover:opacity-100">
                <Volume2 size={32} />
              </div>
            </button>
          </div>

          <div className="w-12 h-1 bg-gray-200 rounded-full"></div>

          <div className="max-w-lg">
            <div className="text-2xl text-gray-600 font-medium leading-relaxed">
              {item.meaning}
            </div>
          </div>
        </div>

        {/* 底部導航 */}
        <div className="p-6 bg-gray-50 border-t border-gray-100 flex justify-between items-center">
          <button 
            onClick={() => setCurrentStudyIndex(prev => Math.max(0, prev - 1))}
            disabled={currentStudyIndex === 0}
            className="px-4 py-2 text-gray-400 hover:text-gray-600 font-bold disabled:opacity-30"
          >
            上一個
          </button>

          <div className="flex gap-1">
            {sessionData.map((_, idx) => (
              <div 
                key={idx} 
                className={`w-2 h-2 rounded-full ${idx === currentStudyIndex ? 'bg-blue-500' : 'bg-gray-200'}`} 
              />
            ))}
          </div>

          {currentStudyIndex === PAIRS_PER_GAME - 1 ? (
            <button 
              onClick={startLevel2}
              className="flex items-center gap-2 px-6 py-3 bg-green-500 hover:bg-green-600 text-white rounded-lg font-bold shadow-md animate-pulse"
            >
              進入第二關 <ArrowRight size={20} />
            </button>
          ) : (
            <button 
              onClick={() => setCurrentStudyIndex(prev => Math.min(PAIRS_PER_GAME - 1, prev + 1))}
              className="flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-md"
            >
              下一個 <ArrowRight size={20} />
            </button>
          )}
        </div>
      </div>
    );
  };

  const Level2Screen = () => (
    <div className="w-full max-w-4xl mx-auto">
      {/* 遊戲狀態列 */}
      <div className="flex flex-wrap gap-4 justify-between items-center mb-4 bg-white p-4 rounded-xl shadow-sm border-b-4 border-indigo-100">
        <div className="flex items-center gap-2 font-bold text-indigo-800">
          <div className="bg-indigo-100 p-2 rounded-lg"><Star size={20} /></div>
          第二關：記憶配對
        </div>
        
        <div className="flex gap-6 font-mono font-bold text-gray-600">
          <div className="flex flex-col items-center">
            <span className="text-xs text-gray-400 uppercase">進度</span>
            <span className="text-lg text-indigo-600">{solved.length}/{PAIRS_PER_GAME}</span>
          </div>
          <div className="flex flex-col items-center">
            <span className="text-xs text-gray-400 uppercase">步數</span>
            <span className="text-lg text-orange-500">{moves}</span>
          </div>
        </div>

        <button onClick={() => setGameState('menu')} className="text-gray-400 hover:text-gray-600">
          <X size={24} />
        </button>
      </div>

      {/* 卡片網格：改為 5 columns x 4 rows 以容納 20 張卡 */}
      <div className="grid grid-cols-4 sm:grid-cols-5 gap-2 sm:gap-3 select-none">
        {cards.map(card => {
          const isFlipped = flipped.includes(card.id);
          const isSolved = solved.includes(card.pairId);
          const showFace = isFlipped || isSolved;

          return (
            <div 
              key={card.id}
              onClick={() => handleCardClick(card.id)}
              className={`
                relative w-full aspect-[4/5] sm:aspect-[3/4] cursor-pointer perspective-1000 group
                ${isSolved ? 'opacity-0 pointer-events-none transition-opacity duration-700' : 'opacity-100'}
              `}
            >
              <div className={`
                w-full h-full transition-all duration-300 transform-style-3d shadow-sm rounded-lg border-b-4
                ${showFace ? 'rotate-y-180 bg-white border-indigo-200' : 'bg-gradient-to-br from-indigo-500 to-purple-600 border-indigo-800 hover:brightness-110'}
              `} style={{ transform: showFace ? 'rotateY(180deg)' : 'rotateY(0deg)' }}>
                
                {/* 背面 */}
                <div className="absolute w-full h-full backface-hidden flex items-center justify-center">
                  <span className="text-white/20 font-bold text-2xl">?</span>
                </div>

                {/* 正面 */}
                <div className="absolute w-full h-full backface-hidden rotate-y-180 flex items-center justify-center p-2 text-center overflow-hidden bg-white rounded-lg">
                  <span className={`
                    font-bold text-gray-800 leading-snug
                    ${card.type === 'word' ? 'text-lg sm:text-xl text-indigo-700' : 'text-xs sm:text-sm'}
                  `}>
                    {card.content}
                  </span>
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );

  const ResultScreen = () => (
    <div className="flex flex-col items-center justify-center min-h-[500px] p-8 space-y-8 bg-white rounded-xl shadow-lg animate-fade-in text-center">
      <div className="relative">
        <Trophy size={80} className="text-yellow-400 drop-shadow-lg" />
        <div className="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-bounce">
          WIN!
        </div>
      </div>
      
      <div>
        <h2 className="text-3xl font-black text-gray-800 mb-2">闖關成功！</h2>
        <p className="text-gray-500">你成功記住了這 {PAIRS_PER_GAME} 個成語</p>
      </div>

      <div className="bg-gray-50 rounded-xl p-6 w-full max-w-sm border border-gray-100">
        <div className="flex justify-between items-center text-sm text-gray-600 mb-4 border-b pb-2">
          <span>本次成績</span>
          <span className="font-bold text-indigo-600">{moves} 步</span>
        </div>
        <div className="text-left max-h-48 overflow-y-auto custom-scrollbar space-y-2">
          {sessionData.map((item, i) => (
            <div key={i} className="flex justify-between text-xs sm:text-sm">
              <span className="font-bold text-gray-700">{item.word}</span>
              <span className="text-green-600 flex items-center gap-1"><CheckCircle size={10} /> 已精通</span>
            </div>
          ))}
        </div>
      </div>

      <div className="flex gap-4">
        <button 
          onClick={() => setGameState('menu')}
          className="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-xl font-bold transition-colors"
        >
          回主選單
        </button>
        <button 
          onClick={initSession}
          className="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg flex items-center gap-2"
        >
          <RefreshCw size={20} />
          再挑戰 10 題
        </button>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-100 py-6 px-4 font-sans flex items-center justify-center">
      <div className="w-full max-w-4xl">
        {gameState === 'menu' && <MenuScreen />}
        {gameState === 'level1' && <Level1Screen />}
        {gameState === 'level2' && <Level2Screen />}
        {gameState === 'finished' && <ResultScreen />}
      </div>
    </div>
  );
}
