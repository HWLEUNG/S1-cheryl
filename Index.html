import React, { useState, useEffect } from 'react';
import { 
  BookOpen, Brain, Volume2, ArrowRight, Dices, 
  Trophy, User, Star, AlertCircle, Coins, Crown, Users
} from 'lucide-react';

// --- æ•¸æ“šæº (ç¬¬10-40é …) ---
const FULL_DATA = [
  { id: 10, word: "ä¸€è‘‰çŸ¥ç§‹", meaning: "å½¢å®¹å¾å¾®å°çš„äº‹ç‰©ä¾¿æ¨æ–·å‡ºçµæœã€‚" },
  { id: 11, word: "ä¸€è½åƒä¸ˆ", meaning: "åœ°ä½åè²æˆ–äº‹ç‰©å¢ƒæ³æ€¥é€Ÿä¸‹æ»‘ã€‚" },
  { id: 12, word: "å…¥æœ¨ä¸‰åˆ†", meaning: "æ¯”å–»è­°è«–è¦‹è§£éå¸¸æ·±åˆ»ã€ç²¾é—¢ã€‚" },
  { id: 13, word: "ä¹æ­»ä¸€ç”Ÿ", meaning: "å½¢å®¹è™•å¢ƒéå¸¸å±éšªï¼Œæ­»è£é€ƒç”Ÿã€‚" },
  { id: 14, word: "å…«é¢å¨é¢¨", meaning: "å½¢å®¹äººæˆ–äº‹æ°£å‹¢é›„å£¯ï¼Œå¨é¢¨å‡œå‡œã€‚" },
  { id: 15, word: "äººå‚‘åœ°éˆ", meaning: "å½¢å®¹ç§€éº—çš„åœ°æ–¹ï¼Œå­•è‚²å‡ºå‚‘å‡ºäººæ‰ã€‚" },
  { id: 16, word: "åŠ›ä¸å¾å¿ƒ", meaning: "æŒ‡å…§å¿ƒæƒ³åšäº‹ï¼Œä½†èƒ½åŠ›ä¸è¶³ã€‚" },
  { id: 17, word: "ä¸‰æ€è€Œè¡Œ", meaning: "å–»åšäº‹æƒ…å‰è¦å¤šæ¬¡æ·±å…¥è€ƒæ…®æ‰å¯¦è¡Œã€‚" },
  { id: 18, word: "äº¡ç¾Šè£œç‰¢", meaning: "å–»çŠ¯éŒ¯å¾Œï¼Œç«‹å³æƒ³è¾¦æ³•è£œæ•‘ï¼Œä»¥é˜²é‡è¹ˆè¦†è½ã€‚" },
  { id: 19, word: "å¤§ç¾©æ»…è¦ª", meaning: "ç¶­è­·æ­£ç¾©ï¼Œä¸å¾‡ç§ï¼Œä¸è¢’è­·å­å¥³è¦ªæ—ã€‚" },
  { id: 20, word: "å¤§ç™¼é›·éœ†", meaning: "å½¢å®¹éå¸¸æ†¤æ€’ï¼Œå¤§ç™¼è„¾æ°£ã€‚" },
  { id: 21, word: "ä¸Šè¡Œä¸‹æ•ˆ", meaning: "å½¢å®¹ä¸Šç´šæ€æ¨£åšï¼Œä¸‹ç´šè·Ÿè‘—ä»¿æ•ˆã€‚" },
  { id: 22, word: "å¤§å¹å¤§æ“‚", meaning: "æ¯”å–»å¹å™“æˆ–å®£æšã€‚" },
  { id: 23, word: "å¤§é€†ä¸é“", meaning: "å½¢å®¹è¡Œç‚ºå›é€†ï¼Œé•èƒŒå¸¸ç†ï¼Œéå¸¸ä¸é“å¾·ã€‚" },
  { id: 24, word: "å£æ˜¯å¿ƒé", meaning: "æŒ‡å£ä¸­èªªå¾—å¥½è½ï¼Œå¿ƒä¸­æƒ³çš„æ˜¯å¦ä¸€å¥—ã€‚" },
  { id: 25, word: "å£èœœè…¹åŠ", meaning: "å£ä¸­èªªçš„ç”œç¾å‹•è½ï¼Œå¿ƒä¸­å»å­˜è‘—å®³äººçš„æ­¹å¿µã€‚" },
  { id: 26, word: "å£è‹¥æ‡¸æ²³", meaning: "æŒ‡èƒ½è¨€å–„è¾¯ï¼Œèªªè©±æ»”æ»”ä¸çµ•ã€‚" },
  { id: 27, word: "åƒéˆä¸€é«®", meaning: "å½¢å®¹å½¢å‹¢å±æ€¥æˆ–æƒ…æ³å±éšªã€‚" },
  { id: 28, word: "åƒéŒ˜ç™¾ç…‰", meaning: "å½¢å®¹åšäº‹ç¶“éå¤šæ¬¡åå¾©ï¼Œé”åˆ°ç²¾ç›Šæ±‚ç²¾çš„æ•ˆæœã€‚" },
  { id: 29, word: "åƒè¼‰é›£é€¢", meaning: "å½¢å®¹é›£å¾—ä¸€é‡çš„æ©Ÿæœƒã€‚" },
  { id: 30, word: "åƒè®Šè¬åŒ–", meaning: "è¡¨ç¤ºè®ŠåŒ–å¤šç«¯ã€‚" },
  { id: 31, word: "äº•åº•ä¹‹è›™", meaning: "å½¢å®¹è¦‹èç‹¹çª„ï¼Œçœ¼å…‰çŸ­æ·ºã€‚" },
  { id: 32, word: "æ–‡è³ªå½¬å½¬", meaning: "å½¢å®¹æ‰å¾·å…¼å…·ï¼Œæ‰è¯åŠè¡Œç‚ºå¾ˆæ°ç•¶ã€‚" },
  { id: 33, word: "å¤©å€«ä¹‹æ¨‚", meaning: "æŒ‡äº«å—è¦ªå±¬é–“çš„æ­¡æ¨‚ã€‚" },
  { id: 34, word: "å¤©é¦¬è¡Œç©º", meaning: "æ¯”å–»æ‰æ€æ•æ·è±ªæ”¾ï¼Œè©©æ–‡æ°£å‹¢è±ªæ”¾ã€‚" },
  { id: 35, word: "äº”åæ­¥ç¬‘ç™¾æ­¥", meaning: "æ¯”å–»è‡ªå·±æœ‰åŒæ¨£ç¼ºé»ï¼Œå»è­ç¬‘åˆ¥äººã€‚" },
  { id: 36, word: "å¤©èŠ±äº‚å¢œ", meaning: "å½¢å®¹èªªè©±è¨€è©å·§å¦™ï¼Œå¤šæŒ‡èª‡å¤§è€Œä¸åˆ‡å¯¦éš›ã€‚" },
  { id: 37, word: "å¤©ç¶“åœ°ç¾©", meaning: "æŒ‡å­˜åœ¨æ–¼å¤©åœ°é–“ï¼Œä¸å®¹ç½®ç–‘çš„æº–å‰‡å’ŒçœŸç†ã€‚" },
  { id: 38, word: "å¤©è¡£ç„¡ç¸«", meaning: "æŒ‡äº‹ç‰©ååˆ†å‘¨å¯†å®Œå–„ï¼Œæ‰¾ä¸å‡ºç ´ç¶»ã€‚" },
  { id: 39, word: "å¤©çœŸçˆ›æ¼«", meaning: "å½¢å®¹æ€§æƒ…ç´”çœŸã€å¦ç‡ï¼Œæ²’æœ‰é€ ä½œã€‚" },
  { id: 40, word: "äº”é«”æŠ•åœ°", meaning: "å¼•ç”³å½¢å®¹å°åˆ¥äººååˆ†ä½©æœã€‚" }
];

const BOARD_SIZE = 20; 
const TARGET_IDIOMS_COUNT = 10;
const INITIAL_SCORE = 1500;
const RENT_MULTIPLIER = 0.5; // éè·¯è²»æ˜¯åœ°åƒ¹çš„ 50%

// --- èªéŸ³åŠŸèƒ½ ---
const speak = (text) => {
  if ('speechSynthesis' in window) {
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'zh-HK';
    utterance.rate = 0.8;
    const voices = window.speechSynthesis.getVoices();
    const cantoneseVoice = voices.find(v => v.lang.includes('HK') || v.name.includes('Cantonese'));
    if (cantoneseVoice) utterance.voice = cantoneseVoice;
    window.speechSynthesis.speak(utterance);
  }
};

export default function IdiomMonopolyPVP() {
  const [gameState, setGameState] = useState('menu'); 
  const [sessionIdioms, setSessionIdioms] = useState([]);
  const [boardTiles, setBoardTiles] = useState([]);
  
  // æº«ç¿’æ¨¡å¼
  const [studyIndex, setStudyIndex] = useState(0);

  // é›™äººéŠæˆ²ç‹€æ…‹
  const [turn, setTurn] = useState(1); // 1 = Player 1 (Red), 2 = Player 2 (Blue)
  const [players, setPlayers] = useState({
    1: { pos: 0, score: INITIAL_SCORE, name: 'ç©å®¶ 1', color: 'bg-red-500', bg: 'bg-red-50', border: 'border-red-500' },
    2: { pos: 0, score: INITIAL_SCORE, name: 'ç©å®¶ 2', color: 'bg-blue-500', bg: 'bg-blue-50', border: 'border-blue-500' }
  });
  
  const [diceValue, setDiceValue] = useState(1);
  const [isMoving, setIsMoving] = useState(false);
  const [modalContent, setModalContent] = useState(null); 
  const [currentEvent, setCurrentEvent] = useState(null);
  const [gameLog, setGameLog] = useState(["éŠæˆ²é–‹å§‹ï¼è«‹ç©å®¶ 1 æ“²éª°å­ã€‚"]);

  // æ·»åŠ æ—¥èªŒ
  const addLog = (msg) => setGameLog(prev => [msg, ...prev].slice(0, 3));

  // åˆå§‹åŒ–
  const initGame = () => {
    const shuffled = [...FULL_DATA].sort(() => 0.5 - Math.random());
    const selected = shuffled.slice(0, TARGET_IDIOMS_COUNT);
    setSessionIdioms(selected);
    
    // ç”Ÿæˆåœ°åœ–
    const newTiles = Array(BOARD_SIZE).fill(null).map((_, i) => ({ id: i, type: 'empty' }));
    newTiles[0] = { id: 0, type: 'start', label: 'èµ·é»' };
    
    const availableSlots = Array.from({length: 19}, (_, i) => i + 1).sort(() => 0.5 - Math.random());
    
    selected.forEach((idiom, idx) => {
      const slot = availableSlots[idx];
      newTiles[slot] = { 
        id: slot, 
        type: 'idiom', 
        data: idiom,
        price: 400, // åœ°åƒ¹
        rent: 200,  // éè·¯è²»
        owner: null // 1 or 2 or null
      };
    });

    const remainingSlots = availableSlots.slice(TARGET_IDIOMS_COUNT);
    remainingSlots.forEach((slot, idx) => {
      newTiles[slot] = { 
        id: slot, 
        type: idx % 2 === 0 ? 'chance' : 'fate',
        label: idx % 2 === 0 ? 'æ©Ÿæœƒ' : 'å‘½é‹'
      };
    });

    setBoardTiles(newTiles);
    setStudyIndex(0);
    setPlayers({
      1: { pos: 0, score: INITIAL_SCORE, name: 'ç©å®¶ 1', color: 'bg-red-500', bg: 'bg-red-50', border: 'border-red-500' },
      2: { pos: 0, score: INITIAL_SCORE, name: 'ç©å®¶ 2', color: 'bg-blue-500', bg: 'bg-blue-50', border: 'border-blue-500' }
    });
    setTurn(1);
    setGameLog(["éŠæˆ²é–‹å§‹ï¼è«‹å…ˆé€²è¡Œæº«ç¿’ã€‚"]);
    setGameState('study');
  };

  // æ“²éª°å­
  const rollDice = async () => {
    if (isMoving || modalContent) return;
    
    const roll = Math.floor(Math.random() * 6) + 1;
    setDiceValue(roll);
    setIsMoving(true);

    let currentPos = players[turn].pos;
    for (let i = 0; i < roll; i++) {
      await new Promise(r => setTimeout(r, 300));
      currentPos = (currentPos + 1) % BOARD_SIZE;
      
      // æ›´æ–°ä½ç½®
      setPlayers(prev => ({
        ...prev,
        [turn]: { ...prev[turn], pos: currentPos }
      }));

      // ç¶“éèµ·é»
      if (currentPos === 0) {
        addLog(`${players[turn].name} ç¶“éèµ·é»ï¼Œçå‹µ 300 åˆ†`);
        setPlayers(prev => ({
          ...prev,
          [turn]: { ...prev[turn], score: prev[turn].score + 300, pos: currentPos }
        }));
      }
    }

    setIsMoving(false);
    handleTileEvent(currentPos);
  };

  // äº‹ä»¶è™•ç†
  const handleTileEvent = (pos) => {
    const tile = boardTiles[pos];
    const currentPlayer = players[turn];
    const opponent = turn === 1 ? 2 : 1;

    if (tile.type === 'idiom') {
      if (tile.owner === null) {
        // ç„¡ä¸»åœ°ï¼šç­”é¡Œè³¼è²·
        const correctAnswer = tile.data;
        const distractors = sessionIdioms
          .filter(i => i.id !== correctAnswer.id)
          .sort(() => 0.5 - Math.random())
          .slice(0, 3);
        const options = [...distractors, correctAnswer].sort(() => 0.5 - Math.random());
        
        setCurrentEvent({ ...tile, options, correctId: correctAnswer.id });
        setModalContent('question');

      } else if (tile.owner !== turn) {
        // å°æ‰‹çš„åœ°ï¼šä»˜éè·¯è²»
        const rent = tile.rent;
        addLog(`${currentPlayer.name} è¸©ä¸­å°æ‰‹åœ°ç›¤ï¼æ”¯ä»˜ ${rent} åˆ†`);
        
        setPlayers(prev => ({
          ...prev,
          [turn]: { ...prev[turn], score: Math.max(0, prev[turn].score - rent) },
          [opponent]: { ...prev[opponent], score: prev[opponent].score + rent }
        }));
        
        setCurrentEvent({ ...tile, rent });
        setModalContent('pay_rent');

      } else {
        // è‡ªå·±çš„åœ°ï¼šå¹¸é‹
        addLog(`${currentPlayer.name} å›åˆ°è‡ªå·±åœ°ç›¤ï¼Œä¼‘æ¯ä¸€ä¸‹ã€‚`);
        switchTurn();
      }

    } else if (tile.type === 'chance' || tile.type === 'fate') {
      const isChance = tile.type === 'chance';
      const points = isChance ? 200 : -100;
      const texts = isChance 
        ? ["å¶é‡åå¸«æŒ‡é»ï¼Œå­¸æ¥­å¤§é€²ï¼", "åœ¨åœ–æ›¸é¤¨æ’¿åˆ°ç­†è¨˜ã€‚", "åŒå­¸è«‹ä½ é£Ÿé­šè›‹ã€‚"]
        : ["ä¸Šå ‚æ°çœ¼è¨“ï¼Œè¢«è€å¸«ç™¼ç¾ã€‚", "å¿˜è¨˜å¸¶æ›¸æœ¬ã€‚", "é»˜æ›¸ä¸åˆæ ¼ã€‚"];
      
      const text = texts[Math.floor(Math.random() * texts.length)];
      
      setCurrentEvent({ title: isChance ? "æ©Ÿæœƒ" : "å‘½é‹", text, points });
      setModalContent('event');
    } else {
      // èµ·é»æˆ–å…¶ä»–
      switchTurn();
    }
  };

  const handleAnswer = (selectedId) => {
    if (selectedId === currentEvent.correctId) {
      // ç­”å°ï¼šç²å¾—åœ°çš® + å°‘é‡åˆ†æ•¸
      const bonus = 100;
      addLog(`${players[turn].name} ä½”é ˜æˆåŠŸï¼ç²å¾—åœ°çš®åŠ ${bonus} åˆ†`);
      
      // æ›´æ–°åœ°çš®æ“æœ‰è€…
      setBoardTiles(prev => prev.map(t => 
        t.id === currentEvent.id ? { ...t, owner: turn } : t
      ));

      setPlayers(prev => ({
        ...prev,
        [turn]: { ...prev[turn], score: prev[turn].score + bonus }
      }));

      speak("ç­”å°äº†ï¼" + currentEvent.data.word);
      setModalContent('correct');
    } else {
      // ç­”éŒ¯
      addLog(`${players[turn].name} æŒ‘æˆ°å¤±æ•—ï¼ŒéŒ¯å¤±è‰¯æ©Ÿã€‚`);
      setModalContent('wrong');
    }
  };

  const switchTurn = () => {
    // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰åœ°éƒ½æœ‰äººè²·äº†
    const allOwned = boardTiles.filter(t => t.type === 'idiom').every(t => t.owner !== null);
    if (allOwned) {
      setGameState('finished');
    } else {
      setTurn(prev => prev === 1 ? 2 : 1);
    }
  };

  // è¨ˆç®—ç¸½è³‡ç”¢
  const calculateTotal = (playerId) => {
    const cash = players[playerId].score;
    const propertyValue = boardTiles
      .filter(t => t.owner === playerId)
      .reduce((sum, t) => sum + t.price, 0);
    return cash + propertyValue;
  };

  // --- UI Components ---

  const MenuScreen = () => (
    <div className="flex flex-col items-center justify-center min-h-[500px] p-8 space-y-8 bg-white rounded-xl shadow-2xl animate-fade-in border-4 border-indigo-100 text-center">
      <div className="flex gap-4 mb-4">
        <div className="bg-red-500 p-4 rounded-full shadow-lg text-white"><User size={40} /></div>
        <div className="bg-blue-500 p-4 rounded-full shadow-lg text-white"><User size={40} /></div>
      </div>
      
      <div>
        <h1 className="text-4xl font-black text-indigo-900 tracking-tight mb-2">æˆèªå¤§å¯Œç¿ï¼šé›™äººå°æˆ°</h1>
        <p className="text-xl text-gray-500 font-medium">èª°æ‰æ˜¯æˆèªå¤§äº¨ï¼ŸäºŒäººåŒæ©Ÿï¼Œå³æ™‚å°æ±ºï¼</p>
      </div>

      <div className="bg-gray-50 p-6 rounded-xl text-left max-w-md w-full space-y-3">
        <h3 className="font-bold text-gray-800 flex items-center gap-2"><Star size={18} className="text-yellow-500"/> å°æˆ°è¦å‰‡ï¼š</h3>
        <ul className="list-disc list-inside text-sm text-gray-600 space-y-2">
          <li>é›™äººè¼ªæµæ“²éª°å­ç§»å‹•ã€‚</li>
          <li>èµ°åˆ°ç„¡äººåœ°ï¼š<span className="font-bold text-indigo-600">ç­”å°é¡Œç›®</span>å³å¯å…è²»ä½”é ˜ï¼</li>
          <li>èµ°åˆ°å°æ‰‹åœ°ï¼šå¿…é ˆ<span className="font-bold text-red-600">æ”¯ä»˜éè·¯è²»</span>ï¼</li>
          <li>æ‰€æœ‰åœ°çš®è¢«ä½”é ˜å¾Œï¼Œè³‡ç”¢ï¼ˆåˆ†æ•¸+åœ°åƒ¹ï¼‰æœ€é«˜è€…å‹ã€‚</li>
        </ul>
      </div>

      <button 
        onClick={initGame}
        className="w-full max-w-xs px-8 py-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-2xl font-bold text-xl shadow-xl transform transition hover:scale-105 active:scale-95 flex items-center justify-center gap-2"
      >
        <Users /> é–‹å§‹å°æˆ°
      </button>
    </div>
  );

  const StudyScreen = () => {
    const item = sessionIdioms[studyIndex];
    return (
      <div className="flex flex-col h-full bg-white rounded-xl shadow-xl overflow-hidden max-w-2xl mx-auto">
        <div className="bg-indigo-600 text-white p-4 flex justify-between items-center">
          <span className="font-bold text-lg flex items-center gap-2"><BookOpen/> è³½å‰æº–å‚™ (å…©ä½è«‹ä¸€èµ·çœ‹)</span>
          <span className="bg-indigo-800 px-3 py-1 rounded-full text-xs">{studyIndex + 1} / {TARGET_IDIOMS_COUNT}</span>
        </div>
        
        <div className="flex-1 p-8 flex flex-col items-center justify-center text-center space-y-6">
          <div className="text-sm text-gray-400">è«‹å…©ä½ç©å®¶ä¸€èµ·è¨˜ä½é€™å€‹æˆèª</div>
          <div 
            className="group relative cursor-pointer"
            onClick={() => speak(item.word)}
          >
            <div className="text-5xl font-black text-gray-800 mb-2 group-hover:text-indigo-600 transition-colors">
              {item.word}
            </div>
            <div className="absolute top-0 -right-8 text-indigo-400 opacity-50 group-hover:opacity-100 animate-pulse">
              <Volume2 size={24} />
            </div>
          </div>
          
          <div className="text-xl text-gray-600 font-medium leading-relaxed bg-gray-50 p-6 rounded-xl border border-gray-100 w-full">
            {item.meaning}
          </div>
        </div>

        <div className="p-6 bg-gray-50 flex justify-between">
          <button 
            disabled={studyIndex === 0}
            onClick={() => setStudyIndex(i => i - 1)}
            className="px-6 py-2 rounded-lg font-bold text-gray-500 hover:bg-gray-200 disabled:opacity-30 transition"
          >
            ä¸Šä¸€å€‹
          </button>
          
          {studyIndex < TARGET_IDIOMS_COUNT - 1 ? (
            <button 
              onClick={() => setStudyIndex(i => i + 1)}
              className="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition flex items-center gap-2"
            >
              ä¸‹ä¸€å€‹ <ArrowRight size={18} />
            </button>
          ) : (
            <button 
              onClick={() => setGameState('game')}
              className="px-8 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition shadow-lg animate-bounce flex items-center gap-2"
            >
              æº–å‚™å¥½äº†ï¼é–‹å§‹æ¯”è³½ <Dices size={18} />
            </button>
          )}
        </div>
      </div>
    );
  };

  const PlayerStats = ({ pid }) => {
    const p = players[pid];
    const isTurn = turn === parseInt(pid);
    const properties = boardTiles.filter(t => t.owner === parseInt(pid)).length;
    
    return (
      <div className={`
        flex-1 p-3 rounded-xl border-2 transition-all duration-300
        ${p.bg} ${p.border} ${isTurn ? 'ring-4 ring-offset-2 ring-yellow-400 shadow-lg scale-105 z-10' : 'opacity-80 scale-95'}
      `}>
        <div className="flex items-center justify-between mb-2">
          <span className={`font-bold ${pid === '1' ? 'text-red-700' : 'text-blue-700'} flex items-center gap-2`}>
            <User size={18} className={p.color + " text-white rounded-full p-0.5"}/>
            {p.name}
          </span>
          {isTurn && <span className="text-xs font-bold bg-yellow-400 text-yellow-900 px-2 py-0.5 rounded-full animate-pulse">æˆ‘çš„å›åˆ</span>}
        </div>
        <div className="flex justify-between items-end">
          <div>
            <div className="text-xs text-gray-500">åˆ†æ•¸</div>
            <div className="text-2xl font-black text-gray-800">${p.score}</div>
          </div>
          <div className="text-right">
            <div className="text-xs text-gray-500">åœ°çš®</div>
            <div className="font-bold text-gray-700">{properties} å¡Š</div>
          </div>
        </div>
      </div>
    );
  };

  const renderBoard = () => {
    const getGridPos = (index) => {
      if (index <= 5) return { row: 1, col: index + 1 };
      if (index <= 9) return { row: index - 4, col: 6 };
      if (index <= 15) return { row: 6, col: 6 - (index - 10) };
      return { row: 6 - (index - 15), col: 1 };
    };

    return (
      <div className="grid grid-cols-6 grid-rows-6 gap-1 w-full max-w-2xl aspect-square mx-auto bg-slate-100 p-2 rounded-xl shadow-inner border-4 border-slate-200 relative">
        {/* ä¸­å¿ƒå€åŸŸ */}
        <div className="col-start-2 col-end-6 row-start-2 row-end-6 bg-white rounded-xl shadow-sm flex flex-col p-4 z-10 overflow-hidden">
          {/* ç©å®¶ç‹€æ…‹æ¬„ */}
          <div className="flex gap-2 mb-4 w-full">
            <PlayerStats pid="1" />
            <PlayerStats pid="2" />
          </div>

          {/* éŠæˆ²è¨Šæ¯ */}
          <div className="bg-gray-50 rounded-lg p-2 h-16 overflow-hidden mb-4 text-xs md:text-sm text-gray-600 border border-gray-100">
            {gameLog.map((log, i) => (
              <div key={i} className={`truncate ${i === 0 ? 'font-bold text-gray-800' : 'opacity-60'}`}>
                {i === 0 && '>'} {log}
              </div>
            ))}
          </div>
          
          {/* éª°å­æŒ‰éˆ• */}
          <div className="flex-1 flex flex-col items-center justify-center">
             <button 
              onClick={rollDice}
              disabled={isMoving || modalContent !== null}
              className={`
                relative w-24 h-24 md:w-32 md:h-32 flex items-center justify-center rounded-2xl shadow-xl transition-all
                ${turn === 1 ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'}
                ${(isMoving || modalContent) ? 'opacity-50 cursor-not-allowed' : 'hover:scale-105 cursor-pointer'}
              `}
            >
                {isMoving ? (
                   <div className="animate-spin text-4xl text-white">ğŸ²</div>
                ) : (
                  <div className="text-white text-center">
                    <Dices size={40} className="mx-auto mb-1" />
                    <span className="font-bold block text-sm">{players[turn].name}<br/>æ“²éª°å­</span>
                  </div>
                )}
             </button>
             {diceValue > 0 && !isMoving && <div className="mt-2 font-bold text-gray-400">é»æ•¸: {diceValue}</div>}
          </div>
        </div>

        {/* æ ¼å­ */}
        {boardTiles.map((tile, i) => {
          const pos = getGridPos(i);
          const p1Here = players[1].pos === i;
          const p2Here = players[2].pos === i;
          
          // æ ¼å­æ¨£å¼
          let borderClass = "border-gray-300";
          let bgClass = "bg-white";
          
          if (tile.type === 'start') bgClass = "bg-yellow-100";
          else if (tile.type === 'chance') bgClass = "bg-orange-100";
          else if (tile.type === 'fate') bgClass = "bg-purple-100";
          else if (tile.owner === 1) { bgClass = "bg-red-100"; borderClass = "border-red-400"; }
          else if (tile.owner === 2) { bgClass = "bg-blue-100"; borderClass = "border-blue-400"; }

          return (
            <div 
              key={i}
              className={`
                relative flex flex-col items-center justify-center text-center p-0.5 md:p-1 rounded-md border-2 text-[9px] md:text-xs font-bold transition-all
                ${bgClass} ${borderClass}
              `}
              style={{ gridRow: pos.row, gridColumn: pos.col }}
            >
              {tile.type === 'idiom' ? (
                <>
                  <span className={tile.owner ? (tile.owner === 1 ? 'text-red-800' : 'text-blue-800') : 'text-gray-600'}>
                    {tile.data.word}
                  </span>
                  {tile.owner && (
                     <div className={`absolute top-0 right-0 p-0.5 text-[8px] text-white rounded-bl ${tile.owner === 1 ? 'bg-red-500' : 'bg-blue-500'}`}>
                       ${tile.rent}
                     </div>
                  )}
                </>
              ) : (
                 <span className="opacity-70">{tile.label}</span>
              )}

              {/* æ£‹å­ */}
              <div className="absolute bottom-0 w-full flex justify-center gap-1 pb-0.5">
                {p1Here && <div className="w-3 h-3 md:w-4 md:h-4 bg-red-500 rounded-full border-2 border-white shadow-md animate-bounce" style={{animationDelay: '0s'}}></div>}
                {p2Here && <div className="w-3 h-3 md:w-4 md:h-4 bg-blue-500 rounded-full border-2 border-white shadow-md animate-bounce" style={{animationDelay: '0.2s'}}></div>}
              </div>
            </div>
          );
        })}
      </div>
    );
  };

  const Modal = () => {
    if (!modalContent) return null;

    const bg = turn === 1 ? 'bg-red-50' : 'bg-blue-50';
    const btnBg = turn === 1 ? 'bg-red-600 hover:bg-red-700' : 'bg-blue-600 hover:bg-blue-700';
    const borderColor = turn === 1 ? 'border-red-200' : 'border-blue-200';

    return (
      <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4 backdrop-blur-sm animate-fade-in">
        <div className={`bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden border-4 ${borderColor}`}>
          
          {/* å•é¡Œæ¨¡å¼ */}
          {modalContent === 'question' && (
            <div className="p-6">
              <div className="flex justify-between items-center mb-4">
                <span className={`px-3 py-1 rounded-full text-sm font-bold text-white ${turn === 1 ? 'bg-red-500' : 'bg-blue-500'}`}>
                  {players[turn].name} çš„å›åˆ
                </span>
                <span className="text-yellow-600 font-bold flex items-center gap-1">
                  ç­”å°å³å¯ä½”é ˜
                </span>
              </div>
              
              <div className="mb-6">
                <p className="text-gray-500 text-sm mb-2">è«‹é¸å‡ºå°æ‡‰æ„æ€çš„æˆèªï¼š</p>
                <p className="text-lg font-bold text-gray-800 bg-gray-50 p-4 rounded-lg">
                  {currentEvent.data.meaning}
                </p>
              </div>

              <div className="grid grid-cols-1 gap-3">
                {currentEvent.options.map((opt, idx) => (
                  <button
                    key={idx}
                    onClick={() => handleAnswer(opt.id)}
                    className="p-4 rounded-xl border-2 border-gray-100 hover:border-indigo-500 hover:bg-indigo-50 text-left font-bold text-gray-700 transition-all"
                  >
                    {opt.word}
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* ä»˜ç§Ÿé‡‘ */}
          {modalContent === 'pay_rent' && (
            <div className="p-8 text-center bg-red-50">
               <div className="mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mb-4 text-red-600">
                <Coins size={32} />
              </div>
              <h3 className="text-2xl font-bold text-red-800 mb-2">å“å‘€ï¼è¸©ä¸­å°æ‰‹åœ°ç›¤</h3>
              <p className="text-red-700 mb-6">
                é€™è£¡æ˜¯ <strong>{players[turn===1?2:1].name}</strong> çš„é ˜åœ°ã€‚<br/>
                æˆèªï¼š{currentEvent.data.word}<br/>
                <span className="font-bold text-lg mt-2 block">æ”¯ä»˜éè·¯è²»: ${currentEvent.rent}</span>
              </p>
              <button 
                onClick={() => { setModalContent(null); switchTurn(); }}
                className="w-full py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700"
              >
                æ”¯ä»˜ä¸¦çµæŸå›åˆ
              </button>
            </div>
          )}

          {/* æ©Ÿæœƒ/å‘½é‹/çµæœé€šç”¨ */}
          {['event', 'correct', 'wrong'].includes(modalContent) && (
            <div className={`p-8 text-center ${modalContent === 'correct' ? 'bg-green-50' : 'bg-white'}`}>
              <h3 className="text-2xl font-bold mb-4">
                {modalContent === 'correct' && "å›ç­”æ­£ç¢ºï¼"}
                {modalContent === 'wrong' && "å›ç­”éŒ¯èª¤"}
                {modalContent === 'event' && currentEvent.title}
              </h3>
              
              {modalContent === 'correct' && <p className="mb-6">æˆåŠŸä½”é ˜åœ°ç›¤ï¼Œè³‡ç”¢å¤§å¢ï¼</p>}
              {modalContent === 'wrong' && (
                 <div className="mb-6">
                    <p className="text-gray-500 mb-2">å¾ˆéºæ†¾ï¼Œåœ°ç›¤è¢«é–’ç½®äº†ã€‚</p>
                    <p className="text-sm bg-gray-100 p-2 rounded">æ­£ç¢ºç­”æ¡ˆï¼š{currentEvent.data.word}</p>
                 </div>
              )}
              {modalContent === 'event' && (
                <p className="mb-6 text-lg">{currentEvent.text} <br/>
                  <span className={`font-bold ${currentEvent.points > 0 ? 'text-green-600' : 'text-red-600'}`}>
                    {currentEvent.points > 0 ? '+' : ''}{currentEvent.points} åˆ†
                  </span>
                </p>
              )}

              <button 
                onClick={() => { setModalContent(null); switchTurn(); }}
                className={`w-full py-3 text-white rounded-xl font-bold ${btnBg}`}
              >
                ç¢ºå®š
              </button>
            </div>
          )}
        </div>
      </div>
    );
  };

  const FinishedScreen = () => {
    const p1Total = calculateTotal(1);
    const p2Total = calculateTotal(2);
    const winner = p1Total > p2Total ? 1 : (p2Total > p1Total ? 2 : 0);

    return (
      <div className="flex flex-col items-center justify-center min-h-[500px] p-8 text-center space-y-6 bg-white rounded-xl shadow-lg">
        <Crown size={80} className="text-yellow-400 drop-shadow-lg" />
        <h2 className="text-4xl font-black text-indigo-900">å°æˆ°çµæŸï¼</h2>
        
        <div className="flex gap-6 w-full max-w-lg justify-center mt-4">
          <div className={`flex-1 p-4 rounded-xl border-4 ${winner === 1 ? 'border-yellow-400 bg-yellow-50 transform scale-110 shadow-xl' : 'border-gray-100 bg-gray-50 opacity-70'}`}>
            <div className="text-xl font-bold text-red-700 mb-2">ç©å®¶ 1</div>
            <div className="text-3xl font-black text-gray-800">${p1Total}</div>
            <div className="text-xs text-gray-500 mt-1">è³‡ç”¢ç¸½å€¼</div>
          </div>
          <div className={`flex-1 p-4 rounded-xl border-4 ${winner === 2 ? 'border-yellow-400 bg-yellow-50 transform scale-110 shadow-xl' : 'border-gray-100 bg-gray-50 opacity-70'}`}>
            <div className="text-xl font-bold text-blue-700 mb-2">ç©å®¶ 2</div>
            <div className="text-3xl font-black text-gray-800">${p2Total}</div>
            <div className="text-xs text-gray-500 mt-1">è³‡ç”¢ç¸½å€¼</div>
          </div>
        </div>

        <div className="text-2xl font-bold text-indigo-600 mt-6">
          {winner === 0 ? "å‹¢å‡åŠ›æ•µï¼å¹³æ‰‹ï¼" : `æ­å–œ ${players[winner].name} ç²å‹ï¼`}
        </div>

        <button 
          onClick={initGame}
          className="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-indigo-700 transition mt-8"
        >
          å†ä¾†ä¸€å±€
        </button>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-slate-100 py-4 px-2 md:py-8 font-sans flex flex-col items-center">
      <div className="w-full max-w-4xl">
        {gameState === 'menu' && <MenuScreen />}
        {gameState === 'study' && <StudyScreen />}
        {gameState === 'game' && <div className="space-y-4">{renderBoard()}</div>}
        {gameState === 'finished' && <FinishedScreen />}
      </div>
      <Modal />
    </div>
  );
}
